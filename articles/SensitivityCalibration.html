<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sensitivity analysis and calibration • medfate</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Sensitivity analysis and calibration">
<meta property="og:description" content="medfate">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">medfate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/emf-creaf/medfate/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="SensitivityCalibration_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Sensitivity analysis and calibration</h1>
                        <h4 class="author">Miquel De Caceres</h4>
            
            <h4 class="date">2021-06-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/emf-creaf/medfate/blob/master/vignettes/SensitivityCalibration.Rmd"><code>vignettes/SensitivityCalibration.Rmd</code></a></small>
      <div class="hidden name"><code>SensitivityCalibration.Rmd</code></div>

    </div>

    
    
<!-- Compile using (Rmd is not included in build): -->
<!-- rmarkdown::render("vignettes/SensitivityCalibration.Rmd",output_dir = "vignettes") -->
<div id="about-this-vignette" class="section level2">
<h2 class="hasAnchor">
<a href="#about-this-vignette" class="anchor"></a>About this vignette</h2>
<p>The present document shows how to conduct a sensitivity analyses and calibration exercises on the simulation models included in package <code>medfate</code>. The document is written assuming that the user is familiarized with the basic water balance model (i.e. function <code>spwb</code>). The aim of the exercises presented here are:</p>
<ol style="list-style-type: decimal">
<li>To determine which <code><a href="../reference/spwb.html">spwb()</a></code> model parameters are more influential in determining stand transpiration and plant drought stress.</li>
<li>To determine which model parameters are more influential to determine model fit to soil water content dynamics.</li>
<li>To reduce the uncertainty in parameters determining fine root distribution, given an observed data set of soil water content dynamics.</li>
</ol>
</div>
<div id="preparing-model-inputs" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-model-inputs" class="anchor"></a>Preparing model inputs</h2>
<p>As an example data set we will use here the same data sets provided to illustrate simulation functions in <strong>medfate</strong>. This data set consists of a forest with two tree species (<em>Pinus halepensis</em>/T1_54 and <em>Quercus ilex</em>/T2_68) and one shrub species (<em>Quercus coccifera</em>/S1_65 or Kermes oak).</p>
<p>We begin by loading the package and the example forest data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/emf-creaf/medfate">medfate</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">exampleforestMED</span><span class="op">)</span>
<span class="va">exampleforestMED</span></code></pre></div>
<pre><code>## $ID
## [1] "1"
## 
## $patchsize
## [1] 10000
## 
## $treeData
##   Species   N   DBH Height Z50  Z95
## 1      54 168 37.55    800 750 3000
## 2      68 384 14.60    660 750 3000
## 
## $shrubData
##   Species Cover Height Z50  Z95
## 1      65  3.75     80 300 1500
## 
## $herbCover
## [1] 10
## 
## $herbHeight
## [1] 20
## 
## attr(,"class")
## [1] "forest" "list"</code></pre>
<p>We also load the example weather data set and the default species parametrization:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">examplemeteo</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">SpParamsMED</span><span class="op">)</span></code></pre></div>
<p>We then initialize a soil with four layers (default values of texture, bulk density and rock content) and the species input parameters for simulation function <code><a href="../reference/spwb.html">spwb()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">examplesoil1</span> <span class="op">=</span> <span class="fu"><a href="../reference/soil.html">soil</a></span><span class="op">(</span><span class="fu"><a href="../reference/defaultSoilParams.html">defaultSoilParams</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="../reference/modelInput.html">forest2spwbInput</a></span><span class="op">(</span><span class="va">exampleforestMED</span>,<span class="va">examplesoil1</span>, <span class="va">SpParamsMED</span>, control <span class="op">=</span> <span class="fu"><a href="../reference/defaultControl.html">defaultControl</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Although it is not necessary, we make an initial call to the model (<code><a href="../reference/spwb.html">spwb()</a></code>) with the default parameter settings:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">S1</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/spwb.html">spwb</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">examplemeteo</span>, latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<pre><code>## Initial soil water content (mm): 291.257
## Initial snowpack content (mm): 0
## Performing daily simulations 
##  Year 2001:....................................done.
## Final soil water content (mm): 271.373
## Final snowpack content (mm): 0
## Change in soil water content (mm): -19.8834
## Soil water balance result (mm): -19.8834
## Change in snowpack water content (mm): 0
## Snowpack water balance result (mm): 0
## Water balance components:
##   Precipitation (mm) 513
##   Rain (mm) 462 Snow (mm) 51
##   Interception (mm) 85 Net rainfall (mm) 377
##   Infiltration (mm) 418 Runoff (mm) 10 Deep drainage (mm) 102
##   Soil evaporation (mm) 45 Transpiration (mm) 290</code></pre>
<p>Function <code><a href="../reference/spwb.html">spwb()</a></code> will be implicitly called multiple times in the sensitivity analyses and calibration analyses that we will illustrate below.</p>
</div>
<div id="sensitivity-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#sensitivity-analysis" class="anchor"></a>Sensitivity analysis</h2>
<div id="introduction-and-input-factors" class="section level3">
<h3 class="hasAnchor">
<a href="#introduction-and-input-factors" class="anchor"></a>Introduction and input factors</h3>
<p>Model sensitivity analyses are used to investigate how variation in the output of a numerical model can be attributed to variations of its <em>input factors</em>. Input factors are elements that can be changed before model execution and may affect its output. They can be model parameters, initial values of state variables, boundary conditions or the input forcing data (Pianosi et al. 2016).</p>
<p>According to Saltelli et al. (2016), there are three main purposes of sensitivity analyses:</p>
<ul>
<li>
<em>Ranking</em> aims at generating the ranking of the input factors according to their relative contribution to the output variability.</li>
<li>
<em>Screening</em> aims at identifying the input factors, if any, which have a negligible influence on the output variability.</li>
<li>
<em>Mapping</em> aims at determining the region of the input variability space that produces significant output values.</li>
</ul>
<p>Here we will mostly interested in ranking parameters according to different objectives. We will take as input factors three plant traits (leaf area index, fine root distribution and the water potential corresponding to a reduction in plant conductance) in the three plant cohorts (species), and two soil factors (the rock fragment content of soil layer 1 and 2). In total, eleven model parameters will be studied. The following shows the initial values for plant trait parameters:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x1</span><span class="op">$</span><span class="va">above</span><span class="op">$</span><span class="va">LAI_live</span></code></pre></div>
<pre><code>## [1] 0.81670117 0.79779523 0.04817502</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x1</span><span class="op">$</span><span class="va">below</span><span class="op">$</span><span class="va">Z50</span></code></pre></div>
<pre><code>## [1] 750 750 300</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x1</span><span class="op">$</span><span class="va">paramsTransp</span><span class="op">$</span><span class="va">Psi_Extract</span></code></pre></div>
<pre><code>## [1] -3.00 -3.92 -3.96</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x1</span><span class="op">$</span><span class="va">soil</span><span class="op">$</span><span class="va">rfc</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<pre><code>## [1] 25 45</code></pre>
<p>In the following code we define a vector of parameter names (using naming rules of function <code><a href="../reference/modifyParams.html">modifyInputParams()</a></code>) as well as the input variability space, defined by the minimum and maximum parameter values:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Parameter names of interest</span>
<span class="va">parNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T1_54/LAI_live"</span>, <span class="st">"T2_68/LAI_live"</span>, <span class="st">"S1_65/LAI_live"</span>,
             <span class="st">"T1_54/Z50"</span>, <span class="st">"T2_68/Z50"</span>, <span class="st">"S1_65/Z50"</span>,
             <span class="st">"T1_54/Psi_Extract"</span>, <span class="st">"T2_68/Psi_Extract"</span>, <span class="st">"S1_65/Psi_Extract"</span>,
             <span class="st">"rfc@1"</span>, <span class="st">"rfc@2"</span><span class="op">)</span>
<span class="co">#Parameter minimum and maximum values</span>
<span class="va">parMin</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,
           <span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span>,
           <span class="op">-</span><span class="fl">7</span>,<span class="op">-</span><span class="fl">7</span>,<span class="op">-</span><span class="fl">7</span>,
           <span class="fl">25</span>,<span class="fl">25</span><span class="op">)</span>
<span class="va">parMax</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span>,
           <span class="fl">1000</span>,<span class="fl">1000</span>,<span class="fl">1000</span>,
           <span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span>,
           <span class="fl">75</span>,<span class="fl">75</span><span class="op">)</span></code></pre></div>
</div>
<div id="model-output-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#model-output-functions" class="anchor"></a>Model output functions</h3>
<p>In sensitivity analyses, model output is summarized into a single variable whose variation is to be analyzed. Pianosi et al. (2016) distinguish two types of model output functions:</p>
<ul>
<li>
<em>objective functions</em> (also called loss or cost functions), which are measures of model performance calculated by comparison of modelled and observed variables.</li>
<li>
<em>prediction functions</em>, which are scalar values that are provided to the model-user for their practical use, and that can be computed even in the absence of observations.</li>
</ul>
<p>Here we will use examples of both kinds. First, we define a function that, given a simulation result, calculates total transpiration (mm) over the simulated period (one year):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sf_transp</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">WaterBalance</span><span class="op">$</span><span class="va">Transpiration</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">}</span>
<span class="fu">sf_transp</span><span class="op">(</span><span class="va">S1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 290.32</code></pre>
<p>Another prediction function can focus on plant drought stress. We define a function that, given a simulation result, calculates the average drought stress of plants (measured using the water stress index) over the simulated period:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sf_stress</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lai</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">spwbInput</span><span class="op">$</span><span class="va">above</span><span class="op">$</span><span class="va">LAI_live</span>
  <span class="va">lai_p</span> <span class="op">&lt;-</span> <span class="va">lai</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">lai</span><span class="op">)</span>
  <span class="va">stress</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_stress.html">spwb_stress</a></span><span class="op">(</span><span class="va">x</span>, index<span class="op">=</span><span class="st">"WSI"</span>, draw <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">stress</span>,<span class="fl">2</span>, <span class="va">lai_p</span>, <span class="st">"*"</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">sf_stress</span><span class="op">(</span><span class="va">S1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 19.61006</code></pre>
<p>Sensitivity analysis requires model output functions whose parameters are the input factors to be studied. <span class="math display">\[\begin{equation}
y = g(\mathbf{x}) = g(x_1, x_2, \dots, x_n)
\end{equation}\]</span> where <span class="math inline">\(y\)</span> is the output, <span class="math inline">\(g\)</span> is the output function and <span class="math inline">\(\mathbf{x} = \{x_1, x_2, \dots, x_n\}\)</span> is the vector of parameter input factors. Functions <code>of_transp</code> and <code>of_stress</code> take simulation results as input, not values of input factors. Instead, we need to define functions that take soil and plant trait values as input, run the soil plant water balance model and return the desired prediction or performance statistic. These functions can be generated using the function factory <code><a href="../reference/optimization.html">optimization_function()</a></code>. The following code defines one of such functions focusing on total transpiration:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">of_transp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/optimization.html">optimization_function</a></span><span class="op">(</span>parNames <span class="op">=</span> <span class="va">parNames</span>,
                                 x <span class="op">=</span> <span class="va">x1</span>,
                                 meteo <span class="op">=</span> <span class="va">examplemeteo</span>, 
                                 latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span>,
                                 summary_function <span class="op">=</span> <span class="va">sf_transp</span><span class="op">)</span></code></pre></div>
<p>Note that we provided all the data needed for simulations as input to <code><a href="../reference/optimization.html">optimization_function()</a></code>, as well as the names of the parameters to study and the function <code>sf_transp</code>. The resulting object <code>of_transp</code> is a function itself, which we can call with parameter values (or sets of parameter values) as input:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">of_transp</span><span class="op">(</span><span class="va">parMin</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 55.93924</code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">of_transp</span><span class="op">(</span><span class="va">parMax</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 295.2266</code></pre>
<p>It is important to understand the steps that are done when we call <code>of_transp()</code>:</p>
<ol style="list-style-type: decimal">
<li>The function <code>of_transp()</code> calls <code><a href="../reference/spwb.html">spwb()</a></code> using all the parameters specified in its construction (i.e. in the call to the function factory), except for the input factors indicated in <code>parNames</code>, which are specified as input at the time of calling <code>of_transp()</code>.</li>
<li>The result of soil plant water balance is then passed to function <code>sf_transp()</code> and the output of this last function is returned as output of <code>of_transp()</code>.</li>
</ol>
<p>We can build a similar model output function, in this case focusing on plant stress (note that the only difference in the call to the factory is in the specification of <code>sf_stress</code> as summary function, instead of <code>sf_transp</code>).</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">of_stress</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/optimization.html">optimization_function</a></span><span class="op">(</span>parNames <span class="op">=</span> <span class="va">parNames</span>,
                                 x <span class="op">=</span> <span class="va">x1</span>, 
                                 meteo <span class="op">=</span> <span class="va">examplemeteo</span>, 
                                 latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span>,
                                 summary_function <span class="op">=</span> <span class="va">sf_stress</span><span class="op">)</span>
<span class="fu">of_stress</span><span class="op">(</span><span class="va">parMin</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.7316116</code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">of_stress</span><span class="op">(</span><span class="va">parMax</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 121.2211</code></pre>
<p>As mentioned above, another kind of output function can be the evaluation of model performance. Here we will assume that performance in terms of predictability of soil water content is desired; and use a data set of ‘observed’ values (actually simulated values with gaussian error) as reference:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">exampleobs</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">exampleobs</span><span class="op">)</span></code></pre></div>
<pre><code>##                  SWC       ETR   E_T1_54    E_T2_68 FMC_T1_54 FMC_T2_68
## 2001-01-01 0.3011510 2.3005942 0.1978736 0.13801522  114.5775  80.88000
## 2001-01-02 0.3010875 2.1730074 0.3276864 0.35661927  114.7509  80.86862
## 2001-01-03 0.3009588 0.6576791 0.2887782 0.20276305  114.9627  80.90105
## 2001-01-04 0.2999961 1.8676609 0.1117854 0.03894549  114.5753  80.92264
## 2001-01-05 0.3013339 1.9435798 0.2205287 0.32509362  114.6784  80.88126
## 2001-01-06 0.3027711 2.3977036 0.2315638 0.16822893  115.0324  80.95727
##              BAI_T1_54    BAI_T2_68
## 2001-01-01  0.06658998 -0.002778926
## 2001-01-02  0.14088739  0.011933739
## 2001-01-03 -0.06324214  0.032796549
## 2001-01-04 -0.11298281 -0.006411667
## 2001-01-05  0.08116292 -0.024324354
## 2001-01-06  0.15782495 -0.037228647</code></pre>
<p>where soil water content dynamics is in column <code>SWC</code>. The model fit to observed data can be measured using the Nash-Sutcliffe coefficient, which we calculate for the initial run using function <code><a href="../reference/evaluation.html">evaluation_metric()</a></code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/evaluation.html">evaluation_metric</a></span><span class="op">(</span><span class="va">S1</span>, measuredData <span class="op">=</span> <span class="va">exampleobs</span>, type <span class="op">=</span> <span class="st">"SWC"</span>, 
                  metric <span class="op">=</span> <span class="st">"NSE"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.9226711</code></pre>
<p>A call to <code><a href="../reference/evaluation.html">evaluation_metric()</a></code> provides the coefficient given a model simulation result, but is not a model output function as we defined above. Analogously to the measures of total transpiration and average plant stress, we can use a function factory to define a model output function that takes input factors as inputs, runs the model and performs the evaluation:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">of_eval</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/optimization.html">optimization_evaluation_function</a></span><span class="op">(</span>parNames <span class="op">=</span> <span class="va">parNames</span>,
                x <span class="op">=</span> <span class="va">x1</span>,
                meteo <span class="op">=</span> <span class="va">examplemeteo</span>, latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span>,
                measuredData <span class="op">=</span> <span class="va">exampleobs</span>, type <span class="op">=</span> <span class="st">"SWC"</span>, 
                metric <span class="op">=</span> <span class="st">"NSE"</span><span class="op">)</span></code></pre></div>
<p>Function <code>of_eval()</code> stores internally both the data needed for conducting simulations and the data needed for evaluating simulation results, so that we only need to provide values for the input factors:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">of_eval</span><span class="op">(</span><span class="va">parMin</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.8896676</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">of_eval</span><span class="op">(</span><span class="va">parMax</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -7.202206</code></pre>
</div>
<div id="global-sensitivity-analyses" class="section level3">
<h3 class="hasAnchor">
<a href="#global-sensitivity-analyses" class="anchor"></a>Global sensitivity analyses</h3>
<p>Sensitivity analysis is either referred to as <em>local</em> or <em>global</em>, depending on variation of input factors is studied with respect to some initial parameter set (local) or the whole space of input factors is taken into account (global). Here we will conduct global sensitivity analyses using package <strong>sensitivity</strong> (Ioss et al. 2020):</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sensitivity</span><span class="op">)</span></code></pre></div>
<p>This package provides a suite of approaches to global sensitivity analysis. Among them, we will follow the <em>Elementary Effect Test</em> implemented in function <code><a href="https://rdrr.io/pkg/sensitivity/man/morris.html">morris()</a></code>. We call this function to analyze sensitivity of total transpiration simulated by <code><a href="../reference/spwb.html">spwb()</a></code> to input factors (500 runs are done, so be patient):</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sa_transp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/morris.html">morris</a></span><span class="op">(</span><span class="va">of_transp</span>, <span class="va">parNames</span>, r <span class="op">=</span> <span class="fl">50</span>, 
             design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"oat"</span>, levels <span class="op">=</span> <span class="fl">10</span>, grid.jump <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, 
             binf <span class="op">=</span> <span class="va">parMin</span>, bsup <span class="op">=</span> <span class="va">parMax</span>, scale<span class="op">=</span><span class="cn">TRUE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Apart from indicating the sampling design to sample the input factor space, the call to <code><a href="https://rdrr.io/pkg/sensitivity/man/morris.html">morris()</a></code> includes the response model function (in our case <code>of_transp</code>), the parameter names and parameter value boundaries (i.e. <code>parMin</code> and <code>parMax</code>).</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sa_transp</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## morris(model = of_transp, factors = parNames, r = 50, design = list(type = "oat",     levels = 10, grid.jump = 3), binf = parMin, bsup = parMax,     scale = TRUE, verbose = T)
## 
## Model runs: 600 
##                           mu   mu.star     sigma
## T1_54/LAI_live     56.549494 68.554275 91.194953
## T2_68/LAI_live     79.848092 82.974055 81.918659
## S1_65/LAI_live     76.963737 76.963737 80.583675
## T1_54/Z50         -28.117870 30.252204 24.068224
## T2_68/Z50         -17.493150 25.584556 24.969127
## S1_65/Z50         -14.291406 18.766508 18.950535
## T1_54/Psi_Extract  -8.613655  8.613655  6.973561
## T2_68/Psi_Extract  -7.560123  7.560123  7.531907
## S1_65/Psi_Extract  -4.549155  4.549155  4.199574
## rfc@1             -29.975953 29.975953 22.288449
## rfc@2             -43.618475 43.618475 24.402543</code></pre>
<p><code>mu.star</code> values inform about the mean of elementary effects of each <span class="math inline">\(i\)</span> factor and can be used to rank all the input factors, whereas <code>sigma</code> inform about the degree of interaction of the <span class="math inline">\(i\)</span>-th factor with others. According to the result of this sensitivity analysis, leaf area index (<code>LAI_live</code>) parameters are the most relevant to determine total transpiration, much more than fine root distribution (<code>Z50</code>), the rock fragment content in the soil and the water potentials corresponding to whole-plant conductance reduction (i.e. <code>Psi_Extract</code>).</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="va">sa_transp</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-20-1.png" width="480" style="display: block; margin: auto;"></p>
<p>We can run the same sensitivity analysis but focusing on the input factors relevant for predicted plant drought stress (i.e. using <code>of_stress</code> as model output function):</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sa_stress</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/morris.html">morris</a></span><span class="op">(</span><span class="va">of_stress</span>, <span class="va">parNames</span>, r <span class="op">=</span> <span class="fl">50</span>, 
             design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"oat"</span>, levels <span class="op">=</span> <span class="fl">10</span>, grid.jump <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, 
             binf <span class="op">=</span> <span class="va">parMin</span>, bsup <span class="op">=</span> <span class="va">parMax</span>, scale<span class="op">=</span><span class="cn">TRUE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sa_stress</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## morris(model = of_stress, factors = parNames, r = 50, design = list(type = "oat",     levels = 10, grid.jump = 3), binf = parMin, bsup = parMax,     scale = TRUE, verbose = TRUE)
## 
## Model runs: 600 
##                           mu   mu.star     sigma
## T1_54/LAI_live     220.47966 220.47966 123.98518
## T2_68/LAI_live     168.35045 168.35045 109.58008
## S1_65/LAI_live     169.26099 169.26099  94.23641
## T1_54/Z50           37.88943  41.38910  46.63908
## T2_68/Z50           34.40458  39.82291  58.82098
## S1_65/Z50           42.48172  44.92090  41.41790
## T1_54/Psi_Extract -115.81427 115.81427  85.49135
## T2_68/Psi_Extract -103.02679 103.02679  72.77754
## S1_65/Psi_Extract  -70.18363  70.18363  57.68731
## rfc@1               42.35095  42.35095  31.97437
## rfc@2               47.83777  47.98895  35.67034</code></pre>
<p>Again, LAI values parameters are the most relevant, but closely followed by the water potentials corresponding to whole-plant conductance reduction (i.e. <code>Psi_Extract</code>), which appear as more relevant than parameters of fine root distribution (<code>Z50</code>) and rock fragment content (<code>rfc</code>).</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="va">sa_stress</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">300</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-24-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Finally, we can study the contribution of input factors to model performance in terms of soil water content dynamics (i.e. using <code>of_eval</code> as model output function):</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sa_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/morris.html">morris</a></span><span class="op">(</span><span class="va">of_eval</span>, <span class="va">parNames</span>, r <span class="op">=</span> <span class="fl">50</span>, 
             design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"oat"</span>, levels <span class="op">=</span> <span class="fl">10</span>, grid.jump <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, 
             binf <span class="op">=</span> <span class="va">parMin</span>, bsup <span class="op">=</span> <span class="va">parMax</span>, scale<span class="op">=</span><span class="cn">TRUE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sa_eval</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## morris(model = of_eval, factors = parNames, r = 50, design = list(type = "oat",     levels = 10, grid.jump = 3), binf = parMin, bsup = parMax,     scale = TRUE, verbose = T)
## 
## Model runs: 600 
##                           mu   mu.star     sigma
## T1_54/LAI_live    -46.385632 46.385632 56.833236
## T2_68/LAI_live    -38.769907 39.462833 45.610514
## S1_65/LAI_live    -31.705964 31.705964 33.320498
## T1_54/Z50          72.694156 72.694156 78.245478
## T2_68/Z50          55.505483 55.505483 52.172413
## S1_65/Z50          44.808304 44.808304 52.872310
## T1_54/Psi_Extract   3.697421  3.697421  7.197762
## T2_68/Psi_Extract   3.656282  3.656282  9.140657
## S1_65/Psi_Extract   1.931226  1.931226  3.823457
## rfc@1             -46.920809 46.920809 35.602770
## rfc@2               0.000000  0.000000  0.000000</code></pre>
<p>Contrary to the previous cases, the contribution of LAI parameters is similar to that of parameters of fine root distribution (<code>Z50</code>), which appear as more relevant than the water potentials corresponding to whole-plant conductance reduction (i.e. <code>Psi_Extract</code>).</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="va">sa_eval</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-28-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="calibration" class="section level2">
<h2 class="hasAnchor">
<a href="#calibration" class="anchor"></a>Calibration</h2>
<p>By model calibration we mean here the process of finding suitable parameter values (or suitable parameter distributions) given a set of observations. Hence, the idea is to optimize the correspondence between model predictions and observations by changing model parameter values.</p>
<div id="defining-parameter-space-and-objective-function" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-parameter-space-and-objective-function" class="anchor"></a>Defining parameter space and objective function</h3>
<p>To simplify our analysis and avoid problems of parameter identifiability, we focus here on the calibration of parameter <code>Z50</code> of fine root distribution. Below we redefine vectors <code>parNames</code>, <code>parMin</code>, and <code>parMax</code>; and we specify a vector of initial values.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Parameter names of interest</span>
<span class="va">parNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T1_54/Z50"</span>, <span class="st">"T2_68/Z50"</span>, <span class="st">"S1_65/Z50"</span><span class="op">)</span>
<span class="co">#Parameter minimum and maximum values</span>
<span class="va">parMin</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span>
<span class="va">parMax</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1000</span>,<span class="fl">1000</span>,<span class="fl">1000</span><span class="op">)</span>
<span class="va">parIni</span> <span class="op">=</span> <span class="va">x1</span><span class="op">$</span><span class="va">below</span><span class="op">$</span><span class="va">Z50</span></code></pre></div>
<p>In order to run calibration analyses we need to define an objective function. Many evaluation metrics could be used but it is common practice to use <em>likelihood functions</em> . We can use the function factory <code>optimization_evaluation_function</code> and the ‘observed’ data to this aim, but in this case we specify a log-likelihood with Gaussian error as the evaluation metric for <code>of_eval()</code>.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">of_eval</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/optimization.html">optimization_evaluation_function</a></span><span class="op">(</span>parNames <span class="op">=</span> <span class="va">parNames</span>,
                x <span class="op">=</span> <span class="va">x1</span>,
                meteo <span class="op">=</span> <span class="va">examplemeteo</span>, latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span>,
                measuredData <span class="op">=</span> <span class="va">exampleobs</span>, type <span class="op">=</span> <span class="st">"SWC"</span>, 
                metric <span class="op">=</span> <span class="st">"loglikelihood"</span><span class="op">)</span></code></pre></div>
</div>
<div id="calibration-by-gradient-search" class="section level3">
<h3 class="hasAnchor">
<a href="#calibration-by-gradient-search" class="anchor"></a>Calibration by gradient search</h3>
<p>Model calibration can be performed using a broad range of approaches. Many of them - including simulated annealing, genetic algorithms, gradient methods, etc. - focus on the maximization or minimization of the objective function. To illustrate this common approach, we will use function <code>optim</code> from package <strong>stats</strong>, which provides several optimization methods. In particular we will use “L-BFGS-B”, which is the “BFGS” quasi-Newton method published by Broyden, Fletcher, Goldfarb and Shanno, modified by the inclusion of minimum and maximum boundaries. By default, function <code>optim</code> performs the minimization of the objective function (here <code>of_eval</code>), but we can specify a negative value for control parameter <code>fnscale</code> to turn the process into a maximization of maximum likelihood:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">opt_cal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">parIni</span>, <span class="va">of_eval</span>, method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fnscale <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>The calibration result is the following:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">opt_cal</span><span class="op">)</span></code></pre></div>
<pre><code>## $par
## [1] 762.1804 762.1580 302.1945
## 
## $value
## [1] 1335.592
## 
## $counts
## function gradient 
##        6        6 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</code></pre>
<p>Note that the optimized parameters are close to those of <code>Z50</code> in the original <code>x1</code>.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span> <span class="va">x1</span><span class="op">$</span><span class="va">below</span><span class="op">[</span>,<span class="st">"Z50"</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">opt_cal</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></code></pre></div>
<pre><code>##       Z50 opt_cal$par
## T1_54 750    762.1804
## T2_68 750    762.1580
## S1_65 300    302.1945</code></pre>
<p>This occurs because these default values were used to generate the ‘observed’ data in <code>exampleobs</code>, which contains a small amount of non-systematic error.</p>
</div>
<div id="bayesian-calibration" class="section level3">
<h3 class="hasAnchor">
<a href="#bayesian-calibration" class="anchor"></a>Bayesian calibration</h3>
<p>As an example of a more sophisticated model calibration, we will conduct a Bayesian calibration analysis using package <strong>BayesianTools</strong> (Hartig et al. 2019):</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/florianhartig/BayesianTools">BayesianTools</a></span><span class="op">)</span></code></pre></div>
<p>In a Bayesian analysis one evaluates how the uncertainty in model parameters is changed (hopefully reduced) after observing some data, because observed values do not have the same likelihood under all regions of the parameter space. For a Bayesian analysis we need to specify a (log)likelihood function and the prior distribution (i.e. the initial uncertainty) of the input factors. The central object in the <strong>BayesianTools</strong> package is the <code>BayesianSetup</code>. This class, created by calls to <code><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html">createBayesianSetup()</a></code>, contains the information about the model to be fit (likelihood), and the priors for model parameters. In absence of previous data, we specify a uniform distribution between the minimum and maximum values, which in the <strong>BayesianTools</strong> package can be done using function <code><a href="https://rdrr.io/pkg/BayesianTools/man/createUniformPrior.html">createUniformPrior()</a></code>:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createUniformPrior.html">createUniformPrior</a></span><span class="op">(</span><span class="va">parMin</span>, <span class="va">parMax</span>, <span class="va">parIni</span><span class="op">)</span>
<span class="va">mcmc_setup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html">createBayesianSetup</a></span><span class="op">(</span>likelihood <span class="op">=</span> <span class="va">of_eval</span>, 
                                  prior <span class="op">=</span> <span class="va">prior</span>, 
                                  names <span class="op">=</span> <span class="va">parNames</span><span class="op">)</span></code></pre></div>
<p>Function <code><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html">createBayesianSetup()</a></code> automatically creates the posterior and various convenience functions for the Markov Chain Monte Carlo (MCMC) samplers. The <code><a href="https://rdrr.io/pkg/BayesianTools/man/runMCMC.html">runMCMC()</a></code> function is the main wrapper for all other implemented MCMC functions. Here we call it with three chains of 3000 iterations each.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/runMCMC.html">runMCMC</a></span><span class="op">(</span>
  bayesianSetup <span class="op">=</span> <span class="va">mcmc_setup</span>, 
  sampler <span class="op">=</span> <span class="st">"DEzs"</span>,
  settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">1000</span>, nrChains <span class="op">=</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>By default <code><a href="https://rdrr.io/pkg/BayesianTools/man/runMCMC.html">runMCMC()</a></code> uses parallel computation, but the calibration process is nevertheless rather slow.</p>
<p>A summary function is provided to inspect convergence results and correlation between parameters:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mcmc_out</span><span class="op">)</span></code></pre></div>
<pre><code>## Parameter values  759.71375388525 748.202113236463 558.78422896857</code></pre>
<pre><code>## Problem encountered in the calculation of the likelihood with parameter 759.71375388525748.202113236463558.78422896857
##  Error message wasError in resetInputs(x, soil): unused argument (soil)
## 
##  set result of the parameter evaluation to -Inf ParameterValues</code></pre>
<pre><code>## # # # # # # # # # # # # # # # # # # # # # # # # # 
## ## MCMC chain summary ## 
## # # # # # # # # # # # # # # # # # # # # # # # # # 
##  
## # MCMC sampler:  DEzs 
## # Nr. Chains:  9 
## # Iterations per chain:  1000 
## # Rejection rate:  0.815 
## # Effective sample size:  381 
## # Runtime:  1621.505  sec. 
##  
## # Parameters
##             psf     MAP    2.5%  median   97.5%
## T1_54/Z50 1.043 627.839 580.046 741.939 989.060
## T2_68/Z50 1.035 889.719 569.645 734.803 981.448
## S1_65/Z50 1.030 480.428 121.669 555.615 965.331
## 
## ## DIC:  -Inf 
## ## Convergence 
##  Gelman Rubin multivariate psrf:  1.049 
##  
## ## Correlations 
##           T1_54/Z50 T2_68/Z50 S1_65/Z50
## T1_54/Z50     1.000    -0.884    -0.097
## T2_68/Z50    -0.884     1.000    -0.066
## S1_65/Z50    -0.097    -0.066     1.000</code></pre>
<p>According to the Gelman-Rubin diagnostic, the convergence can be accepted because the multivariate potential scale reduction factor was ≤ 1.1. We can plot the Markov Chains and the posterior density distribution of parameters that they generate using:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="va">mcmc_out</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-40-1.png" width="633.6"> We can also plot the marginal prior and posterior density distributions for each parameter. In this case, we see a similar <code>Z50</code> distribution for the two trees, which is more informative than the prior distribution. In contrast, the posterior distribution of <code>Z50</code> for the kermes oak remains as uncertain as the prior one. This happens because the LAI value of kermes oak is low, so that it has small influence on soil water dynamics regardless of its root distribution.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/marginalPlot.html">marginalPlot</a></span><span class="op">(</span><span class="va">mcmc_out</span>, prior <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-41-1.png" width="633.6"></p>
<p>Plots can also be produced to display the correlation between parameter values.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/correlationPlot.html">correlationPlot</a></span><span class="op">(</span><span class="va">mcmc_out</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-42-1.png" width="633.6"> Here it can be observed the large correlation between <code>Z50</code> of the two tree cohorts. Since their LAI values are similar, a similar effect on soil water depletion can be obtained to some extent by exchanging their fine root distribution.</p>
<p>Posterior model prediction distributions can be obtained if we take samples from the Markov chains and use them to perform simulations (here we use sample size of 99 but a larger value is preferred).</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html">getSample</a></span><span class="op">(</span><span class="va">mcmc_out</span>, numSamples <span class="op">=</span> <span class="fl">99</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></code></pre></div>
<pre><code>##      T1_54/Z50 T2_68/Z50 S1_65/Z50
## [1,]  957.5108  342.2688  475.9529
## [2,]  803.5055  250.0038  610.7945
## [3,]  979.6384  379.2092  951.8966
## [4,]  634.6976  910.1615  698.5915
## [5,]  161.8533  641.4018  286.4261
## [6,]  641.1469  758.0742  376.1948</code></pre>
<p>To this aim, <strong>medfate</strong> includes function <code><a href="../reference/optimization.html">multiple_runs()</a></code> that allows running a simulation model with a matrix of parameter values. For example, the following code runs <code><a href="../reference/spwb.html">spwb()</a></code> with all combinations of fine root distribution specified in <code>s</code>.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">MS</span> <span class="op">=</span> <span class="fu"><a href="../reference/optimization.html">multiple_runs</a></span><span class="op">(</span><span class="va">s</span>, x <span class="op">=</span> <span class="va">x1</span>, meteo <span class="op">=</span> <span class="va">examplemeteo</span>,
                   latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Function <code><a href="../reference/optimization.html">multiple_runs()</a></code> determines the model to be called inspecting the class of <code>x</code> (here <code>x1</code> is a <code>spwbInput</code>). Once we have conducted the simulations we can inspect the posterior distribution of several prediction variables, for example total transpiration:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">MS</span>, <span class="va">sf_transp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Posterior transpiration"</span>, 
     xlab <span class="op">=</span> <span class="st">"Total transpiration (mm)"</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-45-1.png" width="480"></p>
<p>or average plant drought stress:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">MS</span>, <span class="va">sf_stress</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
     xlab <span class="op">=</span> <span class="st">"Average plant stress"</span>, main<span class="op">=</span><span class="st">"Posterior stress"</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-46-1.png" width="480"></p>
<p>Finally, we can use object <code>prior</code> to generate another sample under the prior parameter distribution, perform simulations:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s_prior</span> <span class="op">=</span> <span class="va">prior</span><span class="op">$</span><span class="fu">sampler</span><span class="op">(</span><span class="fl">99</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">s_prior</span><span class="op">)</span><span class="op">&lt;-</span> <span class="va">parNames</span>
<span class="va">MS_prior</span> <span class="op">=</span> <span class="fu"><a href="../reference/optimization.html">multiple_runs</a></span><span class="op">(</span><span class="va">s_prior</span>, x <span class="op">=</span> <span class="va">x1</span>, meteo <span class="op">=</span> <span class="va">examplemeteo</span>,
                         latitude <span class="op">=</span> <span class="fl">41.82592</span>, elevation <span class="op">=</span> <span class="fl">100</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>and compare the prior prediction uncertainty with the posterior prediction uncertainty for the same output variables:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">MS_prior</span>, <span class="va">sf_transp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Transpiration"</span>, 
     xlab <span class="op">=</span> <span class="st">"Total transpiration (mm)"</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">280</span>,<span class="fl">295</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1.2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">MS</span>, <span class="va">sf_transp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Prior"</span>, <span class="st">"Posterior"</span><span class="op">)</span>, 
       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>, lty<span class="op">=</span><span class="fl">1</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-48-1.png" width="480"></p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/plot.support.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">MS_prior</span>, <span class="va">sf_stress</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Plant stress"</span>, 
     xlab <span class="op">=</span> <span class="st">"Average plant stress"</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">30</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">MS</span>, <span class="va">sf_stress</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Prior"</span>, <span class="st">"Posterior"</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>, lty<span class="op">=</span><span class="fl">1</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></code></pre></div>
<p><img src="SensitivityCalibration_files/figure-html/unnamed-chunk-49-1.png" width="480"></p>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<ul>
<li>Pianosi, F., Beven, K., Freer, J., Hall, J.W., Rougier, J., Stephenson, D.B., Wagener, T., 2016. Sensitivity analysis of environmental models: A systematic review with practical workflow. Environ. Model. Softw. 79, 214–232. <a href="https://doi.org/10.1016/j.envsoft.2016.02.008" class="uri">https://doi.org/10.1016/j.envsoft.2016.02.008</a>
</li>
<li>Bertrand Iooss, Sebastien Da Veiga, Alexandre Janon, Gilles Pujol, with contributions from Baptiste Broto, Khalid Boumhaout, Thibault Delage, Reda El Amri, Jana Fruth, Laurent Gilquin, Joseph Guillaume, Loic Le Gratiet, Paul Lemaitre, Amandine Marrel, Anouar Meynaoui, Barry L. Nelson, Filippo Monari, Roelof Oomen, Oldrich Rakovec, Bernardo Ramos, Olivier Roustant, Eunhye Song, Jeremy Staum, Roman Sueur, Taieb Touati and Frank Weber (2020). sensitivity: Global Sensitivity Analysis of Model Outputs. R package version 1.23.1. <a href="https://CRAN.R-project.org/package=sensitivity" class="uri">https://CRAN.R-project.org/package=sensitivity</a>
</li>
<li>Florian Hartig, Francesco Minunno and Stefan Paul (2019). BayesianTools: General-Purpose MCMC and SMC Samplers and Tools for Bayesian Statistics. R package version 0.1.7. <a href="https://CRAN.R-project.org/package=BayesianTools" class="uri">https://CRAN.R-project.org/package=BayesianTools</a>
</li>
<li>Saltelli, A., Ratto, M., Andres, T., Campolongo, F., Cariboni, J., Gatelli, D., Saisana, M., Tarantola, S., 2008. Global Sensitivity Analysis. The Primer. Wiley.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Miquel De Cáceres, Shengli Huang, Víctor Granda, Antoine Cabon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
