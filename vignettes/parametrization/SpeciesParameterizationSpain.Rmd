---
title: "Species parameterization for Spain"
author: "Miquel De CÃ¡ceres"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: TRUE
---

## Introduction

This vignette describes the procedures used to obtain the species parameter data table `SpParamsMED` included in package **medfate**. The taxon entities chosen are intended to cover most of the taxa reported in Spanish National Forest Inventory surveys (*Inventario Forestal Nacional* or IFN). 

### Required packages
Installed version of **medfate** should be **ver 2.3** or higher. 
```{r, eval = FALSE}
install.packages("medfate")
```

If the version at CRAN is older, the package should be installed from GitHub. Package **medfateutils** is important for the parametrization process, as it includes several functions useful for parsing data sources and populating parameter tables. Package **medfateutils** is installed only `from GitHub via `remotes::install_github()`.

```{r, eval = FALSE}
remotes::install_github("emf-creaf/medfateutils")
```

Once we have **medfate** and **medfateutils**, we load them as well as other packages needed for this vignette:
```{r message=FALSE}
library(medfate)
library(medfateutils)
library(tidyverse)
library(openxlsx)
```

### Target parameters
The set of species parameters needed to run the models included in **medfate** are described in a dataframe called `SpParamsDefinition`: 


```{r}
data("SpParamsDefinition")
SpParamsDefinition$ParameterName
```
It is obvious that such a sheer number of parameters cannot be searched for manually. Hence, it is important to draw them for data bases. Not all model parameters have their counterpart in publicly-available databases, so even using trait data bases it is unlikely that one finds appropriate parameter values for all species. Luckily, **medfate** has inbuilt imputation procedures to estimate missing values for many parameters before starting model simulations. However, imputed parameter estimates will often be worse than estimates coming from data bases. Hence, we should put a strong effort in finding source parameter data before relying on inbuilt imputation.

### Source data paths

We begin by defining file paths (in my computer) to access source data for parameter filling. Source data includes forest inventory (i.e. IFN) data as well as trait and allometry data bases:
```{r}
IFN_path = "/home/miquel/OneDrive/Datasets/IFN/"
DB_path = "/home/miquel/OneDrive/Professional/Recerca/MedfateSpeciesParametrization/"
```

### Steps to build a species parameter table

The following sections describe different phases required to build a species parameter table for simulations with **medfate**:

 1. Initialize the parameter table with target taxonomic entities.
 2. Draw species parameters from forest inventory (IFN in our case) data.
 3. Populate tree and shrub allometric coefficients from suitable allometric databases.
 4. Populate plant functional traits from available data bases
 5. Populate recruitment limits using bioclimatic data, forest inventory data and previous parameter estimates.
 
## Initialize species parameter table for IFN

The first step to obtain a species parameter table is to define the target  entities that will be considered functionally distinct in **medfate** simulations. There is no *a priori* need to limit such entities to species taxonomy, nor to particular taxonomic ranks. However, in our case we will define either entities either at species or genus level.

### Load IFN taxonomic codification
Model simulations will normally entail a resolution of target entities than forest inventory data. Therefore, it will be usual to lump entities treated as separated in the forest inventory. In our case, we begin by loading shrub and tree species codes used in the second, third, and fourth editions of IFN, i.e. IFN2, IFN3 and IFN4:
```{r}
IFN23_species_data <- read.csv(paste0(IFN_path,"Sources/SpeciesCodesIFN23.txt"), 
                             sep="\t")
IFN23_species_data<-IFN23_species_data[,c(1,2)]
IFN23_species_data$IFNCODE<-as.character(IFN23_species_data$IFNCODE)

IFN4_shrub_species_data <- read.csv(paste0(IFN_path,"Sources/shrubcodesifn4.txt"), 
                             sep="\t")
IFN4_shrub_species_data$IFNCODE<-as.character(IFN4_shrub_species_data$IFNCODE)
IFN4_tree_species_data <- read.csv(paste0(IFN_path,"Sources/treecodesifn4.txt"), 
                                    sep="\t")
IFN4_tree_species_data$IFNCODE<-as.character(IFN4_tree_species_data$IFNCODE)
IFN4_tree_species_data<-IFN4_tree_species_data[,c(1,2)]
```

Merge the two code data sets by adding to the codes of IFN2-3 those species codes that were new in IFN4:
```{r}
newShrubs <- !(IFN4_shrub_species_data$IFNCODE %in% IFN23_species_data$IFNCODE)
newTrees <- !(IFN4_tree_species_data$IFNCODE %in% IFN23_species_data$IFNCODE)
IFN_species_data <- bind_rows(IFN23_species_data, 
                              IFN4_shrub_species_data[newShrubs, ], 
                              IFN4_tree_species_data[newTrees,])
IFN_species_data <- IFN_species_data[order(as.numeric(IFN_species_data$IFNCODE)),]
```
The final table of species names and codes is:
```{r}
dim(IFN_species_data)
head(IFN_species_data)
```

### Define IFN codes to exclude
We used the word 'species' for IFN entities, but in fact not all IFN entities are binomial species. In some cases, subspecies are recorded, while in others identification is at genus level or even uses non-scientific names. We thus need to manually define a set of entities (IFN codes) to be excluded because they have low taxonomic content or refer to unsuitable growth forms (vines):
```{r}
codesOut <- c("19", # Otras coniferas 
              "10", # Sin asignar
              "20", # Pinos
              "29", # Otros pinos
              "30",  #Mezcla de coniferas
              "40", #Quercus
              "49", #Otros quercus
              "50", #Mezcla de <e1>rboles de ribera
              "59", #Otros <e1>rboles rip<ed>colas
              "70", #Mezcla de frondosas de gran porte
              "80", #Laurisilva
              "89", #Otras laurisilvas
              "90", #Mezcla de peque<f1>as frondosas
              "99", #Otras frondosas
              "1500", # Cultivo en mosaico
              "8000", #	Matorral en mosaico
              "9000", #Herbazal en mosaico
              "3400", #Prado en mosaico
              "3500", #Pastizal-Matorral en mosaico
              "103", #Otras papilionoideas altas
              "104", #Otras papilionoideas bajas
              "3104", #Genista (H.t.<1,5 m)
              "141", #Hedera helix
              "149" #Smilax aspera
              )
```

Remove taxa from the IFN taxonomic definition data frame:
```{r}
IFN_species_data <- IFN_species_data[!(IFN_species_data$IFNCODE %in% codesOut), ]
dim(IFN_species_data)
```

### Define taxonomic entities to merge into groups
Initialization will normally require defining groups of entities to be treated together in **medfate**. In our case, we need to define genus-level groups. These are necessary for taxa where the forest inventory records do not always have identifications at species-level resolution:
```{r}
genus_level <- c("Acacia spp.:7/207/307",
                 "Adenocarpus spp.:2103/3163",
                 "Atriplex spp.:133",
                 "Artemisia spp.:126/159/1159",
                 "Asparagus spp.:138/1138/2138",
                 "Astragalus spp.:6104",
                 "Betula spp.:73/273/373",
                 "Bupleurum spp.:124/1124/2124",
                 "Calicotome spp.:2104/2105/9072",
                 "Chamaerops humilis:369/3690",
                 "Clematis spp.:132/1132/2132",
                 "Crataegus spp.:15/215/315/415/515",
                 "Coronilla spp.:152/1152/3152/5104",
                 "Cotoneaster spp.:118",
                 "Daphne spp.:110/1110/2110/3110",
                 "Dorycnium spp.:154/7104/1154",
                 "Echium sp.:161",
                 "Erinacea spp.:1104/1166",
                 "Eucalyptus spp.:60/61/62/63/64/264/364/464",
                 "Euphorbia spp.:162/1162/2162/3162",
                 "Fraxinus spp.:55/255/355/455",
                 "Genistella spp.:9104",
                 "Helianthemum spp.:142",
                 "Helichrysum spp.:128/2128",
                 "Larix spp.:35/235/335/435",
                 "Lavandula spp.:109/1109/2109/3109/4109",
                 "Lonicera spp.:144/1144/2144/3144/4144/5144/9012",
                 "Halimium spp.:117/1117/4117/5117/6117",
                 "Ilex spp.:65/82/282",
                 "Juglans spp.:75/275",
                 "Morus spp.:399/499/599",
                 "Ononis spp.:156/8104",
                 "Osyris spp.:135/1135/2135",
                 "Platanus spp.:79/279",
                 "Populus spp.:51/52/58/258",
                 "Phlomis spp.:171/1171/2171",
                 "Phoenix spp.:69/269/469",
                 "Prunus spp.:95/295/395/495/595/1095/1195/2950/148",
                 "Pyrus spp.:16/1165/2165",
                 "Retama spp.:4103",
                 "Rhamnus spp.:4/122/1122/2122/3122/4122/389/5122/6122",
                 "Rhododendron spp.:108",
                 "Ribes spp.:131/1131/2131",
                 "Rosa spp.:119",
                 "Rubus spp.:121/1121/2121/3121",
                 "Salix spp.:57/257/357/457/557/657/757/857/858/957",
                 "Sambucus spp.:97/197/297/2970",
                 "Santolina spp.:127/1127/2127",
                 "Sorbus spp.:78/278/378/478/578/678/778",
                 "Spartium spp.:3103/9103",
                 "Spiraea spp.:134/1134",
                 "Tamarix spp.:53/253",
                 "Teline spp.:165/9077/9078/9202",
                 "Teucrium spp.:179/1179",
                 "Tilia spp.:77/277/377",
                 "Thymelaea spp.:151",
                 "Thuja spp.:319",
                 "Thymus spp.:129/1129",
                 "Ulex spp.:157/1103/6103/3164",
                 "Ulmus spp.:56/256/356/456",
                 "Vaccinium spp.:137/1137",
                 "Viburnum spp.:115/1115/4115/3115/2115"
                 )
```
Groups were manually defined as strings where ':' was used to separate the group name from the set of codes forming the group, which were separated using '/'. We also define groups of taxa at species level, where different synonyms are merged, different codes have been used for the same species or the species have subspecies entities which we want to merge: 
```{r}
assimilated_species<-c("Acer campestre:76/776",
                       "Amelanchier ovalis:2/200",
                       "Buxus sempervirens:91/291/2910/9071/9100",
                       "Cistus albidus:101/3101",
                       "Cornus sanguinea:9/900",
                       "Cytisus fontanesii:9074",
                       "Cytisus scoparius:4104/1167/5103/8103",
                       "Cytisus commutatus:9011/9201/9481",
                       "Cytisus oromediterraneus:5155/4167",
                       "Erica scoparia:283/6102",
                       "Erica arborea:83/102/1102",
                       "Euonymus europaeus:5/500",
                       "Frangula alnus:3/300",
                       "Genista horrida:177", # Echinospartum horridum -> Genista horrida
                       "Genista cinerea:8155/1355",
                       "Genista scorpius:155/3155",
                       "Juniperus communis:37/3700",
                       "Juniperus phoenicea:39/238/239/1139",
                       "Medicago arborea:145/9076",
                       "Myrtus communis:6/600",
                       "Myrica faya:81/281",
                       "Pistacia terebinthus:93/9300",
                       "Quercus ilex:45/245",
                       "Quercus faginea:44/344",
                       "Quercus suber:46/646/746/846/946",
                       "Salvia rosmarinus:114") # Rosmarinus officinalis -> Salvia rosmarinus
```

We now build a data frame with group names and codes, by merging the information of these two groups. We now separate group names and the set of codes defining the group:
```{r}
groups_df <- data.frame("Groups" = c(genus_level,
                                     assimilated_species)) %>%
  separate("Groups", into=c("group_names", "group_codes"), sep=":")
head(groups_df)
```

### Initialize species parameter table

Once we have IFN species names and codes, as well the definition of IFN entities to merge, we can call function `initSpParams()` from package **medfateutils**. This function also takes the data frame `SpParamsDefinition` as argument, from which it takes the set of parameter names to be filled:
```{r eval = FALSE}
SpParams <-initSpParams(IFN_species_data$IFNCODE, IFN_species_data$IFNNAME,
                        SpParamsDefinition,
                        groups_df$group_codes, groups_df$group_names,
                        fill_taxonomic = TRUE, verbose = FALSE)
```
Option `fill_taxonomic` tells function `initSpParams()` to use package **taxize** to find taxonomic classification of the species/genus entities.
```{r include = FALSE}
# saveRDS(SpParams, "SpParamsSPAIN_init.rds")
SpParams = readRDS("SpParamsSPAIN_init.rds")
```
The result of calling `initSpParams()` is a data frame with as many rows as target entities and columns corresponding to the parameters defined in `SpParamsDefinition`. Most parameters are missing, obviously, but the function already filled taxonomic data:
```{r}
head(SpParams[,1:7])
```

## Parameters drawn from IFN data

Some plant size parameters, such as maximum height or minimum/maximum values of the height-to-diameter ratio, can be derived from forest inventory data. In addition, it is important that medfate's growth form (either tree or shrub) matches the treatment given in forest inventory surveys. Diameters are normally measured in 'tree' entities, whereas shrubs are often measured using cover indices. Thus, the growth form parameter should also be derived from forest inventory.

### Load IFN data

We first load IFN tree and shrub data corresponding to the three surveys (tree data is in two different tables in the case of IFN2): 
```{r}
shrubDataIFN2 <-readRDS(paste0(IFN_path,"Products/IFN2/Rdata/shrubDataIFN2_Spain.rds"))
shrubDataIFN2$ID<-as.character(shrubDataIFN2$ID)
shrubDataIFN3 <-readRDS(paste0(IFN_path,"Products/IFN3/Rdata/shrubDataIFN3_Spain.rds"))
shrubDataIFN4 <-readRDS(paste0(IFN_path,"Products/IFN4/Rdata/shrubDataIFN4_Spain.rds"))

piesMayoresDataIFN2<-readRDS(paste0(IFN_path,"Products/IFN2/Rdata/piesMayoresDataIFN2_Spain.rds"))
piesMenoresDataIFN2<-readRDS(paste0(IFN_path,"Products/IFN2/Rdata/piesMenoresDataIFN2_Spain.rds"))
piesMenoresDataIFN2$ID = as.character(piesMenoresDataIFN2$ID)
piesMenoresDataIFN2$Species = as.character(piesMenoresDataIFN2$Species)
treeDataIFN3<-readRDS(paste0(IFN_path,"Products/IFN3/Rdata/treeDataIFN3_Spain.rds"))
treeDataIFN4<-readRDS(paste0(IFN_path,"Products/IFN4/Rdata/treeDataIFN4_Spain.rds"))
```
We merge the data sets into two tables, one for shrubs and the other for trees, taking only columns `ID` (plot identification), `Species` (code), `H` (height) and `DBH` (for trees).
```{r}
shrubDataIFN <-bind_rows(shrubDataIFN2[,c("ID","Species", "H")],
                         shrubDataIFN3[,c("ID","Species", "H")],
                         shrubDataIFN4[,c("ID","Species", "H")])

treeDataIFN <-bind_rows(piesMayoresDataIFN2[,c("ID","Species", "H", "DBH")],
                        piesMenoresDataIFN2[,c("ID","Species", "H", "DBH")],
                        treeDataIFN3[,c("ID","Species", "H", "DBH")],
                        treeDataIFN4[,c("ID","Species", "H", "DBH")])
```

### Growth form
To tell medfate which target entities are shrubs, trees (or both, since some species occur in both tree and shrub tables), we can simply take the species code vectors:
```{r}
shrub_codes <- as.numeric(shrubDataIFN$Species)
tree_codes <- as.numeric(treeDataIFN$Species)
```

Before populating growth form, we can check how many species appear both as trees and shrubs:
```{r}
sum(unique(shrub_codes) %in% unique(tree_codes))
```
We can populate column `GrowthForm` of the species parameter table by calling function `populateGrowthForm()` of package **medfateutils**:
```{r}
SpParams = populateGrowthForm(SpParams, 
                              tree_codes, shrub_codes,
                              fill_fromGenus = TRUE)

```
Some codes (particularly, those excluded above) may not be recognized according to the target entity definition of `SpParams` and are ignored. The option `fill_fromGenus = TRUE` is used to tell function `populateGrowthForm()` that all species of the same entity should have the same growth form, so that even if some codes are not mentioned, for whatever reason, growth forms are also defined. Some species may have been defined in the IFN species definition but then be missing from the tree/shrub tables. We identify them and manually set to tree the growth form of these:
```{r}
missingGrowthFormSpecies = SpParams[is.na(SpParams$GrowthForm), c("Name")]
print(missingGrowthFormSpecies)
SpParams$GrowthForm[SpParams$Name %in% missingGrowthFormSpecies] = "Tree"
```

### Maximum/median height

Maximum and median heights for each target entity can be obtained from observed height distributions. Thus, we define species identity and height (in cm) vectors from tree/shrub data:
```{r}
species_codes <- c(treeDataIFN$Species, shrubDataIFN$Species)
height_values <- c(treeDataIFN$H, shrubDataIFN$H)*100 # m to cm
```
and then call function `populateHeightParams()` to populate parameters `Hmax` and `Hmed`, corresponding to maximum and median heights.
```{r}
SpParams <- populateHeightParams(SpParams,
                                 species_codes, height_values)
```
By default, maximum height is defined as the 99% quantile of the height distribution, whereas median height corresponds to the 50% quantile. 

Parameters `Hmax` and `Hmed` are strict, meaning that medfate does not have inbuilt imputation procedures for them, so we must complete their columns in the parameter table. We can inspect the missing values for each growth form: 
```{r}
table(is.na(SpParams$Hmax), SpParams$GrowthForm)
table(is.na(SpParams$Hmed), SpParams$GrowthForm)
```
and then use the species with known values for each growth from to impute species averages:
```{r}
SpParams$Hmax[is.na(SpParams$Hmax) & SpParams$GrowthForm != "Shrub"] = round(mean(SpParams$Hmax[SpParams$GrowthForm != "Shrub"], na.rm=TRUE))
SpParams$Hmax[is.na(SpParams$Hmax) & SpParams$GrowthForm == "Shrub"] = round(mean(SpParams$Hmax[SpParams$GrowthForm == "Shrub"], na.rm=TRUE))

SpParams$Hmed[is.na(SpParams$Hmed) & SpParams$GrowthForm != "Shrub"] = round(mean(SpParams$Hmed[SpParams$GrowthForm != "Shrub"], na.rm=TRUE))
SpParams$Hmed[is.na(SpParams$Hmed) & SpParams$GrowthForm == "Shrub"] = round(mean(SpParams$Hmed[SpParams$GrowthForm == "Shrub"], na.rm=TRUE))
```

### Diameter/height ratio

Minimum and maximum diameter/height ratios are used in medfate to translate diameter growth into height growth. We first assemble three data vectors needed to populate these parameters (heights and diameters in cm):
```{r}
tree_species_codes <- treeDataIFN$Species
tree_height_values <- treeDataIFN$H*100 # m to cm
tree_diameter_values <- treeDataIFN$DBH
```
and then call function `populateTreeDiameterHeightParams()` from package **medfateutils**:
```{r}
SpParams <- populateTreeDiameterHeightParams(SpParams,
                                             tree_species_codes, 
                                             tree_height_values,
                                             tree_diameter_values)
```
This function fills parameters `fHDmin` and `fHDmax`, corresponding to the minimum and maximum values of the height-to-diameter ratio. The 5% and 95% quantile values are used for these parameters, respectively, by default. 

Missing values may occur after imputation:  
```{r}
table(is.na(SpParams$fHDmin), SpParams$GrowthForm)
table(is.na(SpParams$fHDmax), SpParams$GrowthForm)
```
Since `fHDmin` and `fHDmax` are strict parameters, we use shrub and tree averages to fill the remaining cases:
```{r}
SpParams$fHDmax[is.na(SpParams$fHDmax) & SpParams$GrowthForm != "Shrub"] = round(mean(SpParams$fHDmax, na.rm=TRUE))
SpParams$fHDmin[is.na(SpParams$fHDmin) & SpParams$GrowthForm != "Shrub"] = round(mean(SpParams$fHDmin, na.rm=TRUE))
```


## Allometric coefficients

### Shrub allometric equations

```{r}
library(medfuels)
```


```{r}

data("sp_params_area")
data("sp_params_fine")
data("sp_params_total")
data("group_params_area")
data("group_params_fine")
data("group_params_total")
data("species_groups")
```

Correct synonymy mistakes
```{r}

species_groups[species_groups$name=="Rosmarinus officinalis","Genus"]<- "Salvia"
species_groups[species_groups$name=="Rosmarinus officinalis","Species"]<- "rosmarinus"
species_groups[species_groups$name=="Rosmarinus officinalis","author"]<- "Schleid."
species_groups[species_groups$name=="Rosmarinus officinalis","name"]<- "Salvia rosmarinus"

species_groups[species_groups$name=="Lithospermum fruticosum","Genus"]<- "Lithodora"
species_groups[species_groups$name=="Lithospermum fruticosum","Species"]<- "fruticosa"
species_groups[species_groups$name=="Lithospermum fruticosum","author"]<- "(L.) Griseb."
species_groups[species_groups$name=="Lithospermum fruticosum","name"]<- "Lithodora fruticosa"
```


```{r}
shrub_sel <-SpParams$GrowthForm %in% c("Shrub", "Tree/Shrub")
```

```{r}
retrieveCoefficientsFromMedfuels <-function(SpParams, sp_params_allom, group_params_allom, species_groups) {
  a_coef<-rep(NA, nrow(SpParams))
  b_coef<-rep(NA, nrow(SpParams))
  sp_allom = row.names(sp_params_allom)
  gr_allom = row.names(group_params_allom)
  gen_sp = paste(species_groups$Genus, species_groups$Species)
  nshrub <- 0
  nmis <- 0
  for(i in 1:nrow(SpParams)) {
    growth_form <- SpParams$GrowthForm[i]
    if(growth_form %in% c("Shrub", "Tree/Shrub")) {
      nshrub <- nshrub +1
      nm <- SpParams$Name[i]
      gen <- strsplit(nm," ")[[1]][1]
      if(nm %in% sp_allom) { # If species-specific allometry available
        sp_row<-which(sp_allom==nm) 
        a_coef[i] = sp_params_allom$a[sp_row]
        b_coef[i] = sp_params_allom$b[sp_row]
      } else if (nm %in% gen_sp) { # If species is found in medfuels species table
        form_raunkiaer <-  species_groups$`shrub type`[which(gen_sp==nm)[1]]
        gr_row<-which(gr_allom==form_raunkiaer) 
        a_coef[i] = group_params_allom$a[gr_row]
        b_coef[i] = group_params_allom$b[gr_row]
      } else if (gen %in% species_groups$Genus) { # If genus occurs in medfuels table
        forms_raunkiaer <-  species_groups$`shrub type`[which(species_groups$Genus==gen)]
        # Find most-frequent  raunkiaer form
        tfr<-table(forms_raunkiaer)
        tfr<-tfr[order(tfr, decreasing=TRUE)]
        gr_row<-which(gr_allom==names(tfr)[1]) 
        a_coef[i] = group_params_allom$a[gr_row]
        b_coef[i] = group_params_allom$b[gr_row]
      } else {
        nmis <- nmis + 1
        if(growth_form=="Tree/Shrub") { # If tree/shrub assing MPh data
          message(paste0("Data for '", nm,"' could not be retrieved and will be assigned 'MP'."))
          a_coef[i] = group_params_allom["MP","a"]
          b_coef[i] = group_params_allom["MP","b"]
        } else {
          message(paste0("Data for '", nm,"' could not be retrieved and will be assigned 'NP'."))
          a_coef[i] = group_params_allom["NP","a"]
          b_coef[i] = group_params_allom["NP","b"]
        }
      }
    }
  }
  if(nmis>0) message(paste0(nmis,
                            " missing values (out of ",
                            nshrub,
                            " shrub species) after populating with input data.\n"))
  return(data.frame(Name = SpParams$Name, 
                    GrothForm = SpParams$GrowthForm,
                    a = a_coef, b = b_coef))
}
```

```{r}
area_coef_df <- retrieveCoefficientsFromMedfuels(SpParams, 
                                                 sp_params_area, 
                                                 group_params_area, 
                                                 species_groups)
SpParams$a_ash[shrub_sel] <- area_coef_df$a[shrub_sel]
SpParams$b_ash[shrub_sel] <- area_coef_df$b[shrub_sel]

fine_coef_df <- retrieveCoefficientsFromMedfuels(SpParams, 
                                                 sp_params_fine, 
                                                 group_params_fine, 
                                                 species_groups)
SpParams$a_bsh[shrub_sel] <- fine_coef_df$a[shrub_sel]
SpParams$b_bsh[shrub_sel] <- fine_coef_df$b[shrub_sel]

total_coef_df <- retrieveCoefficientsFromMedfuels(SpParams, 
                                                 sp_params_total, 
                                                 group_params_total, 
                                                 species_groups)
SpParams$a_btsh[shrub_sel] <- total_coef_df$a[shrub_sel]
SpParams$b_btsh[shrub_sel] <- total_coef_df$b[shrub_sel]
```

### Shrub crown ratio and Pdead

```{r}
shrub_pdead_cr <- read.table(paste0(DB_path,"AllometryDatabases/ShrubAllometries/Shrub_Pdead_CR.txt"), 
                             sep="\t", dec=",", header=T) %>% 
  separate(Name, c("Genus", "Species"), sep=" ") %>% 
  unite("Name" , c("Genus", "Species"), sep=" ", na.rm=TRUE)
shrub_cr<-data.frame(value = shrub_pdead_cr$CR.mean,
                     row.names = shrub_pdead_cr$Name)
shrub_pdead<-data.frame(value = shrub_pdead_cr$Pdead.mean,
                     row.names = shrub_pdead_cr$Name)

sp_params_allom = shrub_cr[1:27,, drop=FALSE]
group_params_allom = shrub_cr[28:34,, drop=FALSE]

```

```{r}

retrieveValuesFromMedfuels <-function(SpParams, sp_params_allom, 
                                       group_params_allom, species_groups) {
  sp_params_allom <-sp_params_allom[!is.na(sp_params_allom$value),,drop=FALSE]
  group_params_allom <-group_params_allom[!is.na(group_params_allom$value),,drop=FALSE]
  coef<-rep(NA, nrow(SpParams))
  sp_allom = row.names(sp_params_allom)
  gr_allom = row.names(group_params_allom)
  gen_sp = paste(species_groups$Genus, species_groups$Species)
  nshrub <- 0
  nmis <- 0
  for(i in 1:nrow(SpParams)) {
    growth_form <- SpParams$GrowthForm[i]
    if(growth_form %in% c("Shrub", "Tree/Shrub")) {
      nshrub <- nshrub +1
      nm <- SpParams$Name[i]
      gen <- strsplit(nm," ")[[1]][1]
      if(nm %in% sp_allom) { # If species-specific allometry available
        sp_row<-which(sp_allom==nm) 
        coef[i] = sp_params_allom$value[sp_row]
      } else if (nm %in% gen_sp) { # If species is found in medfuels species table
        form_raunkiaer <-  species_groups$`shrub type`[which(gen_sp==nm)[1]]
        if(form_raunkiaer %in% gr_allom) {
          gr_row<-which(gr_allom==form_raunkiaer) 
          coef[i] = group_params_allom$value[gr_row]
        }
      } else if (gen %in% species_groups$Genus) { # If genus occurs in medfuels table
        forms_raunkiaer <-  species_groups$`shrub type`[which(species_groups$Genus==gen)]
        # Find most-frequent  raunkiaer form
        tfr<-table(forms_raunkiaer)
        tfr<-tfr[order(tfr, decreasing=TRUE)]
        if(names(tfr)[1] %in% gr_allom) {
          gr_row<-which(gr_allom==names(tfr)[1])
          coef[i] = group_params_allom$value[gr_row]
        } 
      } 
      
      if(is.na(coef[i])  && (growth_form=="Tree/Shrub") && ("MP" %in% gr_allom) ) { # If tree/shrub assing MPh data
        coef[i] = group_params_allom["MP","value"]
      } 
      if(is.na(coef[i])) {
        message(paste0("Data for '", nm,"' could not be retrieved."))
        nmis <- nmis + 1
      }
    }
  }
  if(nmis>0) message(paste0(nmis,
                            " missing values (out of ",
                            nshrub,
                            " shrub species) after populating with input data.\n"))
  return(data.frame(Name = SpParams$Name, 
                    GrothForm = SpParams$GrowthForm,
                    coef =coef))
}

cr_df <- retrieveValuesFromMedfuels(SpParams, shrub_cr[1:27,, drop=FALSE], shrub_cr[28:34,, drop=FALSE], species_groups)
pdead_df <- retrieveValuesFromMedfuels(SpParams, shrub_pdead[1:27,, drop=FALSE], shrub_pdead[28:34,, drop=FALSE], species_groups)
cr_df$coef[is.na(cr_df$coef)] <- mean(cr_df$coef, na.rm=TRUE)
pdead_df$coef[is.na(pdead_df$coef)] <- mean(pdead_df$coef, na.rm=TRUE)

SpParams$cr[shrub_sel] <-cr_df$coef[shrub_sel]
SpParams$pDead[shrub_sel] <-pdead_df$coef[shrub_sel]
```
### Tree allometries

```{r}
fb_models <- openxlsx::read.xlsx(paste0(DB_path, "AllometryDatabases/TreeAllometries/TreeAllometries.xlsx"), sheet= "Tree_FB_models", rowNames = TRUE)
cr_models <- openxlsx::read.xlsx(paste0(DB_path,"AllometryDatabases/TreeAllometries/TreeAllometries.xlsx"), sheet= "Tree_CR_models", rowNames = TRUE)
cw_models <- openxlsx::read.xlsx(paste0(DB_path,"AllometryDatabases/TreeAllometries/TreeAllometries.xlsx"), sheet= "Tree_CW_models", rowNames = TRUE)

```

```{r}
SpParams <- populateTreeAllometries(SpParams, fb_models, "foliarbiomass", erase_previous = TRUE)
SpParams <- populateTreeAllometries(SpParams, cr_models, "crownratio", erase_previous = TRUE)
SpParams <- populateTreeAllometries(SpParams, cw_models, "crownwidth", erase_previous = TRUE)
```
```{r include = FALSE}
saveRDS(SpParams, "SpParamsSPAIN_allom.rds")
```


## Plant functional traits

### Trait databases (except TRY)
```{r}
#  Hydratry
fn_hydratry <- file.path(DB_path,"TraitDatabases/HydraTRY/HydraTRY.xlsx")
hydratry <- openxlsx::read.xlsx(fn_hydratry, rowNames = FALSE) 

#  Martin-StPaul et al. (2017)
fn_martin_stpaul <- file.path(DB_path,"TraitDatabases/MartinStPaul_et_al_2017/DataBase.xlsx")
martin_stpaul <- read.xlsx(fn_martin_stpaul, sheet="ALL")
martin_stpaul<-martin_stpaul[,c("Species", "P50", "P12", "Ptlp")]

# Choat et al. (2012)
fn_choat <-file.path(DB_path,"TraitDatabases/Choat_et_al_2012/nature11688-s2.xls")
choat <- readxl::read_excel(fn_choat)
choat <-choat[-1, c("Species", "P50", "P88")] # Remove unit row

# Bartlett et al. 2012
fn_bartlett <- file.path(DB_path, "TraitDatabases/Bartlett_et_al_2012/Bartlett_2012_ELE_data.xlsx")
bartlett <- openxlsx::read.xlsx(fn_bartlett, rowNames = FALSE) 

# Duursma et al. 2018
fn_duursma <- file.path(DB_path, "TraitDatabases/Duursma_et_al_2018/gmindatabase.csv")
duursma <- read.csv2(fn_duursma, sep=",")

# Hoshika et al. 2018 
fn_hoshika <- file.path(DB_path, "TraitDatabases/Hoshika_et_al_2018/Hoshika_et_al_2018.xlsx")
hoshika <- openxlsx::read.xlsx(fn_hoshika) 
hoshika$Species <- str_replace(string = hoshika$Species,pattern = "_", replacement = " ")

# BROT
fn_brot2 <- file.path(DB_path, "TraitDatabases/Brot/BROT2_dat.csv")
brot2 <- read.csv2(fn_brot2)

#Global wood density database
# Zanne, A.E., Lopez-Gonzalez, G.*, Coomes, D.A., Ilic, J., Jansen, S., Lewis, S.L., Miller, R.B., Swenson, N.G., Wiemann, M.C., and Chave, J. 2009. Global wood density database. 
# Dryad. Identifier: http://hdl.handle.net/10255/dryad.235.
fn_gwdd <- file.path(DB_path, "TraitDatabases/GlobalWoodDensityDatabase/GlobalWoodDensityDatabase.xls")
gwdd <- readxl::read_excel(fn_gwdd, sheet=2)

# Flammability
fn_flam <- file.path(DB_path, "TraitDatabases/FuelAttributes/FuelAttributes.xlsx")
flam <- readxl::read_excel(fn_flam, sheet=1)

# Fine-fuel ratio
fn_ffr <- file.path(DB_path, "TraitDatabases/FineFuelRatio/FineFuelRatio.xlsx")
ffr <- readxl::read_excel(fn_ffr, sheet=1)

# Fuel moisture content
fn_fmc <- file.path(DB_path, "TraitDatabases/FMC/FMC.xlsx")
fmc_field <- readxl::read_excel(fn_fmc, sheet=1)
fmc_bib <- readxl::read_excel(fn_fmc, sheet=2)

# Yebra et al. (2020)
fn_yebra <- file.path(DB_path, "TraitDatabases/LFMC_Yebra_et_al_2020/Globe-LFMC-v2.xlsx")
fmc_yebra <- openxlsx::read.xlsx(fn_yebra, sheet=2)
```


### Plant/leaf classification
#### Life form

Load TRY life form data 
```{r}
TRY_life_form  <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_343.rds"))
```

Homogenize life form values into six categories:
```{r}
TRY_life_form  <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_343.rds"))
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("Ch", "CH", "Cha", "chamaephyte", "Chamaephytes")] = "Chamaephyte"
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("Cryptophytes", "cryptophyte",
                               "G", "geophyte", "Geophytes")] = "Cryptophyte"
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("Ep", "epiphyte","Epiphytes", "liana")] = "Epiphyte"
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("H", "hemicryptophyte", "Hemicryptophytes")] = "Hemicryptophyte"
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("hydrophyte", "Hydrophytes")] = "Hydrophyte"
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("Mega- meso- and micro- phanerophyte",
                               "Phanerophyte (mega-,meso-, nano-)",
                               "Mega-, meso- and microphanerophyte",
                               "megaphanerophyte", "Megaphanerophyte",
                               "Micro-phanerophytes", "Nanophanerophyt",
                               "nanophanerophyte", "Nanophanerophyte",
                               "phanerophyte", "Phanerophytes", "shrub", "tree")] = "Phanerophyte"
TRY_life_form$OrigValueStr[TRY_life_form$OrigValueStr %in% 
                             c("T", "therophyte", "Therophyte (annual land plant)", "Therophytes")] = "Therophyte"
TRY_life_form<-TRY_life_form[TRY_life_form$OrigValueStr %in% c("Chamaephyte", "Cryptophyte",
                                                               "Epiphyte", "Hemicryptophyte", "Hydrophyte",
                                                               "Phanerophyte")]
```

Call `populateTraits()` to parse TRY values:
```{r}
SpParams <- populateTraits(SpParams, TRY_life_form,
                           trait_mapping = c("LifeForm" = "OrigValueStr"),
                           character_traits = TRUE,
                           taxon_column = "AccSpeciesName")
```


Check which species have missing values:
```{r}
SpParams[is.na(SpParams$LifeForm), c("Name", "LifeForm")]
```
Fill missing values manually:
```{r}
SpParams$LifeForm[SpParams$Name %in% c("Arctostaphylos uva-ursi", "Genistella spp.", 
                                       "Halimium spp.", "Lithodora spp.", "Phlomis spp.",
                                       "Vella spinosa")] = "Chamaephyte"
SpParams$LifeForm[SpParams$Name %in% c("Ampelodesmos mauritanica")] = "Hemicryptophyte"
SpParams$LifeForm[SpParams$Name %in% c("Apollonias canariensis", "Gleditsia triacanthos",
                                       "Heberdenia bahamensis", "Picconia excelsa", "Pleiomeris canariensis",
                                       "Paliurus spina-christi", "Retama spp.", "Teline spp.",
                                       "Visnea mocanera", "Zizyphus lotus")] = "Phanerophyte"
```
Show the number of taxa for each life form:
```{r}
table(SpParams$LifeForm, useNA = "ifany")
```


#### Leaf shape

Load TRY leaf shape data 
```{r}
TRY_leaf_shape  <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_43.rds"))
```

Homogenize TRY leaf shape values into five categories:
```{r}
TRY_leaf_shape$OrigValueStr[TRY_leaf_shape$OrigValueStr %in% 
                             c("broadleaved", "broad-leaved", "B", "broadleaf")] = "Broad"
TRY_leaf_shape$OrigValueStr[TRY_leaf_shape$OrigValueStr %in% 
                              c("needleleaved", "needle-leaved","needle","needle-leaf", "N")] = "Needle"
TRY_leaf_shape$OrigValueStr[TRY_leaf_shape$OrigValueStr %in% 
                              c("scale-shaped", "scale", "scale-like", "scale-leaf")] = "Scale"
TRY_leaf_shape$OrigValueStr[TRY_leaf_shape$OrigValueStr %in% 
                              c("narrowleaved", "linear", "Cylindrical")] = "Linear"
TRY_leaf_shape$OrigValueStr[TRY_leaf_shape$OrigValueStr %in% 
                              c("photosynthetic stem")] = "Spines"
TRY_leaf_shape<-TRY_leaf_shape[TRY_leaf_shape$OrigValueStr %in% 
                                 c("Broad", "Needle", "Scale", "Linear", "Spines"),
                               c("AccSpeciesName", "OrigValueStr")]
names(TRY_leaf_shape) = c("Species", "LeafShape")
```
Homogenize BROT2 leaf shape values into the same five categories:
```{r}
brot2_LeafShape <- brot2 %>% filter(Trait %in% c("LeafShape")) %>% 
  select(c("Taxon", "Data"))
brot2_LeafShape$Data <- paste(toupper(substring(brot2_LeafShape$Data, 1, 1)), 
                              substring(brot2_LeafShape$Data, 2), sep = "")
brot2_LeafShape$Data[brot2_LeafShape$Data=="Needle-like"] = "Needle"
brot2_LeafShape$Data[brot2_LeafShape$Data=="Scale-like"] = "Scale"
names(brot2_LeafShape) = c("Species", "LeafShape")
```
Merge data sets and call `populateTraits()` to parse leaf shape values:
```{r}
LeafShape_data = rbind(brot2_LeafShape,
                       TRY_leaf_shape)
SpParams <- populateTraits(SpParams, LeafShape_data, 
                           trait_mapping = c("LeafShape" = "LeafShape"),
                           character_traits = TRUE,
                           taxon_column = "Species")
```

Show which species have missing values:
```{r}
SpParams[is.na(SpParams$LeafShape), c("Name", "LeafShape")]
```

Fill missing values manually:
```{r}
SpParams$LeafShape[SpParams$Name %in% c("Genistella spp.")] = "Broad"
SpParams$LeafShape[SpParams$Name %in% c("Tetraclinis articulata")] = "Scale"
```
Show the number of taxa for each leaf shape:
```{r}
table(SpParams$LeafShape, useNA = "ifany")
```

#### Leaf size

Load TRY leaf area data: 
```{r}
TRY_leaf_area  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_3110.rds"))
```
Classify TRY leaf area values into three leaf size categories:
```{r}
TRY_leaf_area$LeafSize <-cut(as.numeric(TRY_leaf_area$StdValue), 
                             breaks = c(0,225, 2025,100000), labels = c("Small", "Medium", "Large")) 
TRY_LeafSize<-TRY_leaf_area[,c("AccSpeciesName", "LeafSize")]
names(TRY_LeafSize)[1] = "Species"
```
Split BROT2 data into leaf area values and leaf size strings:
```{r}
brot2_LeafArea <- brot2 %>% filter(Trait %in% c("LeafArea")) %>% 
  select(c("Taxon", "Trait", "Data", "Units"))
brot2_LeafSize <- brot2_LeafArea[brot2_LeafArea$Units=="[5]",]
brot2_LeafArea <- brot2_LeafArea[brot2_LeafArea$Units=="mm2",]
```
Reclassify BROT2 leaf size data into three categories 
```{r}
brot2_LeafSize$Data[brot2_LeafSize$Data=="very small"] = "small"
brot2_LeafSize$Data[brot2_LeafSize$Data=="very large"] = "large"
brot2_LeafSize$Data <- paste(toupper(substring(brot2_LeafSize$Data, 1, 1)), 
                              substring(brot2_LeafSize$Data, 2), sep = "")
brot2_LeafSize <- brot2_LeafSize[,c("Taxon", "Data")]
names(brot2_LeafSize) = c("Species", "LeafSize")
```
Classify BRO2 leaf area values into three categories:
```{r}
brot2_LeafArea$LeafSize = cut(as.numeric(brot2_LeafArea$Data), 
                              breaks = c(0,225, 2025,100000), labels = c("Small", "Medium", "Large")) 
brot2_LeafArea <- brot2_LeafArea[,c("Taxon", "LeafSize")]
names(brot2_LeafArea)[1] = "Species"
```
Merge data sets and call `populateTraits()` to parse leaf size values:
```{r}
LeafSize_data = rbind(brot2_LeafSize,
                      brot2_LeafArea,
                      TRY_LeafSize)

SpParams <- populateTraits(SpParams, LeafSize_data, 
                           trait_mapping = c("LeafSize" = "LeafSize"),
                           character_traits = TRUE,
                           taxon_column = "Species")
```
Show species with missing values:
```{r}
SpParams[is.na(SpParams$LeafSize), c("Name", "LeafSize")]
```
Fill missing values manually:
```{r}
SpParams$LeafSize[SpParams$Name %in% c("Apollonias canariensis",
                                       "Ampelodesmos mauritanica",
                                       "Dracaena drago", "Heberdenia bahamensis",
                                       "Picconia excelsa", "Pleiomeris canariensis",
                                       "Visnea mocanera")] = "Large"
SpParams$LeafSize[SpParams$Name %in% c("Coriaria myrtifolia", "Flueggea tinctoria",
                                       "Kleinia neriifolia", "Rhododendron spp.",
                                       "Sophora japonica")] = "Medium"
SpParams$LeafSize[SpParams$Name %in% c("Adenocarpus spp.", "Cedrus atlantica",
                                       "Cedrus deodara", "Cedrus libani",
                                       "Chamaecyparis lawsoniana",
                                       "Chamaespartium tridentatum",
                                       "Cytisophyllum sessilifolium",
                                       "Daboecia cantabrica",
                                       "Erinacea spp.", "Genistella spp.",
                                       "Paliurus spina-christi", "Pseudotsuga menziesii",
                                       "Spartium spp.", "Teline spp.", "Vella spinosa",
                                       "Zizyphus lotus")] = "Small"
```

Show the number of taxa for each leaf size:
```{r}
table(SpParams$LeafSize, useNA = "ifany")
```

#### Phenology type

```{r}
TRY_phenology  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_37.rds"))
```

```{r}
TRY_phenology$OrigValueStr[TRY_phenology$OrigValueStr %in% 
                             c("evergreen", "E", "EV", "always summer green",
                               "Evergreen broad-leaved", "Evergreen scale-like",
                               "Evergreen needle-leaved")] = "oneflush-evergreen"
TRY_phenology$OrigValueStr[TRY_phenology$OrigValueStr %in% 
                             c("deciduous", "D", "Deciduous broad-leaved", "Deciduous",
                               "Nonevergreen", "winter deciduous")] = "winter-deciduous"
TRY_phenology$OrigValueStr[TRY_phenology$OrigValueStr %in% 
                             c("semi-deciduous",
                               "semi-evergreen")] = "winter-semideciduous"
TRY_phenology$OrigValueStr[TRY_phenology$OrigValueStr %in% 
                             c("drought semi-deciduous")] = "drought-semideciduous"
TRY_phenology<-TRY_phenology[TRY_phenology$OrigValueStr %in% c("progressive-evergreen",
                                                               "oneflush-evergreen", 
                                                               "winter-semideciduous",
                                                               "winter-deciduous",
                                                               "drought-semideciduous")]
TRY_phenology<-TRY_phenology[,c("AccSpeciesName", "OrigValueStr")]
names(TRY_phenology) = c("Species","LeafPhenology")
```

```{r}
brot2_LeafPhenology <- brot2 %>% filter(Trait %in% c("LeafPhenology")) %>% 
  select(c("Taxon", "Data"))
brot2_LeafPhenology$Data[brot2_LeafPhenology$Data=="drought semi-deciduous"] = "drought-semideciduous"
brot2_LeafPhenology$Data[brot2_LeafPhenology$Data=="evergreen"] = "oneflush-evergreen"
brot2_LeafPhenology$Data[brot2_LeafPhenology$Data=="winter deciduous"] = "winter-deciduous"
brot2_LeafPhenology$Data[brot2_LeafPhenology$Data=="winter semi-deciduous"] = "winter-semideciduous"
names(brot2_LeafPhenology) = c("Species","LeafPhenology")
```
Merge data sets and call `populateTraits()` to parse leaf phenology:
```{r}
LeafPhenology_data =rbind(brot2_LeafPhenology,
                          TRY_phenology)
SpParams <- populateTraits(SpParams, LeafPhenology_data, 
                           trait_mapping = c("PhenologyType" = "LeafPhenology"),
                           character_traits = TRUE,
                           taxon_column = "Species")
```
Show which species have missing values:
```{r}
SpParams[is.na(SpParams$PhenologyType), c("Name", "PhenologyType")]
```

Fill missing values manually:
```{r}
SpParams$PhenologyType[SpParams$Name %in% c("Vella spinosa", "Genistella spp.")] = "winter-deciduous"
SpParams$PhenologyType[SpParams$Name %in% c("Pleiomeris canariensis")] = "oneflush-evergreen"
```
Show the number of taxa for each phenology type:
```{r}
table(SpParams$PhenologyType, useNA = "ifany")
```

### Plant size
We already populated some plant size parameters from forest inventory data. Here we draw values for parameters that are not normally measured in forest inventory data (for obvious reasons), such as maximum rooting depth.

#### Maximum rooting depth
```{r}
TRY_Z95 <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_6.rds"))
```


```{r}
TRY_Z95 <-TRY_Z95[TRY_Z95$OriglName %in% c("Max Rooting Depth (m)",
                                           "Rooting depth",
                                           "Rooting depth (m)",
                                           "Rooting depth_max",
                                           "RootDepth"),]
TRY_Z95 <- TRY_Z95[, c("AccSpeciesName", "StdValue")]
names(TRY_Z95) <- c("Species", "Z95")
```

```{r}
brot2_Z95 <- brot2 %>% filter(Trait %in% c("RootDepth")) %>% 
  select(c("Taxon", "Data"))
brot2_Z95$Data <- as.numeric(brot2_Z95$Data)
names(brot2_Z95) <- c("Species", "Z95")
```

```{r}
Z95_data = rbind(TRY_Z95,
                 brot2_Z95)
Z95_data$Z95<- pmax(Z95_data$Z95, 0.15) # Minimum of 15 cm depth
Z95_data$Z95<- pmin(Z95_data$Z95, 10) # Maximum of 10 m depth
SpParams <- populateTraits(SpParams, Z95_data, 
                           trait_mapping = c("Z95" = "Z95"),
                           scalar_functions = c("Z95" = function(x) {round(x*1000)}),
                           taxon_column = "Species")
```

```{r}
table(is.na(SpParams$Z95), SpParams$GrowthForm)
```

```{r}
SpParams$Z95[is.na(SpParams$Z95) & SpParams$GrowthForm != "Shrub"] = round(mean(SpParams$Z95[SpParams$GrowthForm != "Shrub"], na.rm=TRUE))
SpParams$Z95[is.na(SpParams$Z95) & SpParams$GrowthForm == "Shrub"] = round(mean(SpParams$Z95[SpParams$GrowthForm == "Shrub"], na.rm=TRUE))
```

```{r}
table(is.na(SpParams$Z95), SpParams$GrowthForm)
```

### Leaf phenology

#### Leaf duration

```{r}
TRY_LeafDuration  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_12.rds"))
TRY_LeafDuration <- TRY_LeafDuration[, c("AccSpeciesName", "StdValue")]
names(TRY_LeafDuration) <- c("Species", "LeafDuration")
```

Adapt data sources:
```{r}
names(hydratry)[names(hydratry)=="LL"] = "LeafDuration"
brot2_LeafDuration <- brot2 %>% filter(Trait %in% c("LeafLifespan")) %>% 
  select(c("Taxon", "Data"))
brot2_LeafDuration$Data <- as.numeric(brot2_LeafDuration$Data)
names(brot2_LeafDuration) <- c("Species", "LeafDuration")
```

```{r}
LeafDuration_data<-rbind(hydratry[,c("Species","LeafDuration")],
                         TRY_LeafDuration,
                         brot2_LeafDuration)
SpParams <- populateTraits(SpParams, LeafDuration_data, 
                                trait_mapping = c("LeafDuration" = "LeafDuration"),
                                scalar_functions = c("LeafDuration" = function(x) {x/12}),
                                taxon_column = "Species")
```

### Anatomy
#### Specific leaf area

```{r}
TRY_SLA <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_3117.rds"))
TRY_SLA <- TRY_SLA[, c("AccSpeciesName", "StdValue")]
names(TRY_SLA) <- c("Species", "SLA")
```

```{r}
brot2_SLA <- brot2 %>% filter(Trait %in% c("SLA")) %>% 
  select(c("Taxon", "Data"))
brot2_SLA$Data <- as.numeric(brot2_SLA$Data)
names(brot2_SLA) <- c("Species", "SLA")
```

```{r}
SLA_data = rbind(hydratry[,c("Species","SLA")],
                 TRY_SLA,
                 brot2_SLA)
SpParams <- populateTraits(SpParams, SLA_data, 
                           trait_mapping = list("SLA" = "SLA") ,
                           taxon_column = "Species")
```

#### Leaf density

```{r}
TRY_LeafDensity  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_48.rds"))
SpParams <- populateTraits(SpParams, TRY_LeafDensity, 
                           trait_mapping = c("LeafDensity" = "StdValue"),
                           taxon_column = "AccSpeciesName")
```

#### Wood density

```{r}
TRY_WoodDensity  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_4.rds"))
```

```{r}
TRY_WoodDensity <- TRY_WoodDensity[, c("AccSpeciesName", "StdValue")]
names(TRY_WoodDensity) <- c("Species", "WoodDensity")
gwdd_WoodDensity<-gwdd[,c("Binomial", "Wood density (g/cm^3), oven dry mass/fresh volume")]
names(gwdd_WoodDensity)<-c("Species", "WoodDensity")
```

```{r}
names(hydratry)[names(hydratry)=="WD"] = "WoodDensity"
```

```{r}
brot2_WoodDensity <- brot2 %>% filter(Trait %in% c("StemDensity")) %>% 
  select(c("Taxon", "Data"))
brot2_WoodDensity$Data <- as.numeric(brot2_WoodDensity$Data)
names(brot2_WoodDensity) <- c("Species", "WoodDensity")
```

```{r}
WoodDensity_data<-rbind(hydratry[,c("Species","WoodDensity")],
                        TRY_WoodDensity,
                        brot2_WoodDensity,
                        gwdd_WoodDensity)
SpParams <- populateTraits(SpParams, WoodDensity_data, 
                           trait_mapping = c("WoodDensity" = "WoodDensity"),
                           taxon_column = "Species")
```

#### Fine fuel ratio

```{r}
SpParams <- populateTraits(SpParams, as.data.frame(ffr), 
                           trait_mapping = c("r635" = "r635"),
                           taxon_column = "Species")
```

#### Fraction of dead material ($P_{dead}$)

```{r}
table(is.na(SpParams$pDead))
```


```{r}
brot2_DF <- brot2 %>% filter(Trait %in% c("DeadFuel")) %>% 
  select(c("Taxon", "Trait", "Data", "Units")) %>% 
  filter(Units=="%")
brot2_DF$Data <- as.numeric(brot2_DF$Data)
```

```{r}
SpParams <- populateTraits(SpParams, brot2_DF, 
                           trait_mapping = c("pDead" = "Data"),
                           scalar_functions = c("pDead"= function(x){x/100}),
                           taxon_column = "Taxon")
```

#### Leaf area to sapwood area ratio

```{r}
TRY_Hv  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_171.rds"))
```

```{r}
TRY_Hv$StdValue[TRY_Hv$OriglName=="Huber value"]<-1/as.numeric(TRY_Hv$OrigValueStr[TRY_Hv$OriglName=="Huber value"])
TRY_Hv$StdValue[TRY_Hv$OriglName=="leaf.area.per.sapwood.area"]<-TRY_Hv$StdValue[TRY_Hv$OriglName=="leaf.area.per.sapwood.area"]*100
TRY_Hv$StdValue[TRY_Hv$OriglName=="Sapwood: leaf area ratio"]<-10000/as.numeric(TRY_Hv$OrigValueStr[TRY_Hv$OriglName=="Sapwood: leaf area ratio"])
TRY_Hv$StdValue[TRY_Hv$OriglName=="The ratio of leaf area attached per unit sapwood cross-section area (m2 cm-2)"]<-10000*as.numeric(TRY_Hv$OrigValueStr[TRY_Hv$OriglName=="The ratio of leaf area attached per unit sapwood cross-section area (m2 cm-2)"])
TRY_Hv$StdValue[TRY_Hv$OriglName=="values at base of living crown, m2/cm2"]<-10000*as.numeric(TRY_Hv$OrigValueStr[TRY_Hv$OriglName=="values at base of living crown, m2/cm2"])
TRY_Hv$StdValue[TRY_Hv$OriglName=="values at breast height, m2/cm2"]<-10000*as.numeric(TRY_Hv$OrigValueStr[TRY_Hv$OriglName=="values at breast height, m2/cm2"])
summary(TRY_Hv$StdValue)
TRY_Hv <- TRY_Hv[, c("AccSpeciesName", "StdValue")]
names(TRY_Hv) <- c("Species", "Al2As")
```


```{r}
hydratry_Hv <-hydratry[,c("Species","Hv")]
hydratry_Hv$Hv<- 10000/hydratry_Hv$Hv
names(hydratry_Hv) <- c("Species", "Al2As")
```

```{r}
Hv_data<-rbind(TRY_Hv,
               hydratry_Hv)
SpParams <- populateTraits(SpParams, Hv_data,
                           trait_mapping = c("Al2As" = "Al2As"),
                           taxon_column = "Species")
```

#### Leaf width

```{r}
TRY_LW <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_145.rds"))
```

```{r}
SpParams <- populateTraits(SpParams, TRY_LW,
                           trait_mapping = c("LeafWidth" = "StdValue"),
                           taxon_column = "AccSpeciesName")
```

#### Specific root length

```{r}
TRY_SRL  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_614.rds"))
SpParams <- populateTraits(SpParams, TRY_SRL, 
                           trait_mapping = c("SRL" = "StdValue"),
                           taxon_column = "AccSpeciesName")

```

### Tissue moisture
#### Minimum/maximum fuel moisture content

```{r}
fmc_yebra$Species.collected[fmc_yebra$Species.collected=="Rosmarinus officinalis"] = "Salvia officinalis"

FMC_data <- rbind(fmc_field[,c("Species name", "MinFMC_DW", "MaxFMC_DW")],
                  fmc_bib[,c("Species name", "MinFMC_DW", "MaxFMC_DW")])
FMC_data$`Species name`[FMC_data$`Species name`=="Rosmarinus officinalis"] = "Salvia officinalis"
```

```{r}
SpParams <- populateTraits(SpParams, fmc_yebra, 
                           trait_mapping = c("minFMC" = "LFMC.value"),
                           summary_function = function(x) {as.numeric(quantile(x,probs=0.05))},
                           summary_params = NULL,
                           taxon_column = "Species.collected")
SpParams <- populateTraits(SpParams, fmc_yebra, 
                           trait_mapping = c("maxFMC" = "LFMC.value"),
                           summary_function = function(x) {as.numeric(quantile(x,probs=0.95))},
                           summary_params = NULL,
                           taxon_column = "Species.collected")
```


```{r}
SpParams <- populateTraits(SpParams, as.data.frame(FMC_data), 
                           trait_mapping = c("minFMC" = "MinFMC_DW",
                                             "maxFMC" = "MaxFMC_DW"),
                           taxon_column = "Species name", erase_previous = FALSE)
```

#### Leaf pressure-volume curve

```{r}
names(bartlett)[names(bartlett)=="Ïo.(MPa)"] = "LeafPI0"
names(bartlett)[names(bartlett)=="Îµ.(MPa)"] = "LeafEPS"
```

```{r}
TRY_LeafPI0  <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_188.rds"))
TRY_LeafPI0 <- TRY_LeafPI0[, c("AccSpeciesName", "StdValue")]
names(TRY_LeafPI0) <- c("Species", "LeafPI0")
TRY_LeafPI0$LeafPI0 <- -1*TRY_LeafPI0$LeafPI0 
```

```{r}
TRY_LeafEPS  <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_190.rds"))
TRY_LeafEPS$StdValue <- as.numeric(TRY_LeafEPS$OrigValueStr) 
TRY_LeafEPS <- TRY_LeafEPS[, c("AccSpeciesName", "StdValue")]
names(TRY_LeafEPS) <- c("Species", "LeafEPS")
```


```{r}
LeafPI0_data = rbind(TRY_LeafPI0[, c("Species", "LeafPI0")],
                     bartlett[,c("Species", "LeafPI0")])
SpParams <- populateTraits(SpParams, LeafPI0_data, 
                           trait_mapping = c("LeafPI0" = "LeafPI0"),
                           taxon_column = "Species")
```

```{r}
LeafEPS_data = rbind(TRY_LeafEPS[, c("Species", "LeafEPS")],
                     bartlett[,c("Species", "LeafEPS")])
SpParams <- populateTraits(SpParams, LeafEPS_data, 
                           trait_mapping = c("LeafEPS" = "LeafEPS"),
                           taxon_column = "Species")
```

```{r}
SpParams <- populateTraits(SpParams, bartlett, 
                           trait_mapping = c("LeafAF" = "af"),
                           taxon_column = "Species")
```

### Fuel flammability

#### Heat content and surface area to volume ratio

```{r}
SpParams <- populateTraits(SpParams, as.data.frame(flam), 
                           trait_mapping = c("HeatContent" = "High calorific value [J/kg]",
                                             "SAV" = "SurfaceAreaVolume[m2/m3]"),
                           taxon_column = "Species name")
```

#### Lignin content

```{r}
TRY_Lignin  <-readRDS(file.path(DB_path, "TraitDatabases/TRY/TRY_traits/TRY_87.rds"))

SpParams <- populateTraits(SpParams, TRY_Lignin, 
                           trait_mapping = c("LigninPercent" = "StdValue"),
                           scalar_functions = c("LigninPercent" = function(x){x/10}), #mg/g to % 
                           taxon_column = "AccSpeciesName")
```

### Transpiration/photosynthesis
#### Water potential determining stomatal closure

```{r}
names(bartlett)[names(bartlett)=="Ïtlp.(MPa)"] = "Ptlp"
names(hydratry)[names(hydratry)=="PItlp"] = "Ptlp"
```

```{r}
Ptlp_data = rbind(martin_stpaul[, c("Species", "Ptlp")],
                  hydratry[, c("Species", "Ptlp")],
                  bartlett[,c("Species", "Ptlp")])
SpParams <- populateTraits(SpParams, Ptlp_data, 
                           trait_mapping = list("Psi_Extract" = "Ptlp"),
                           taxon_column = "Species")
```

#### Critical water potential

```{r}
P50_data = rbind(martin_stpaul[, c("Species", "P50")],
                 choat[, c("Species", "P50")],
                 hydratry[, c("Species", "P50")])
```

```{r}
SpParams <- populateTraits(SpParams, P50_data, 
                           trait_mapping = list("Psi_Critic" = "P50"),
                           taxon_column = "Species")
```

#### Water use efficiency

```{r}
TRY_WUE  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_134.rds"))
TRY_WUE <- TRY_WUE %>% filter(StdValue < 40)
SpParams <- populateTraits(SpParams, TRY_WUE, 
                           trait_mapping = c("WUE" = "StdValue"),
                           taxon_column = "AccSpeciesName")
```

#### Minimum/maximum stomatal conductance
 ($G_{swmin}$ and $G_{swmax}$)
```{r}
duursma$gmin <- as.numeric(duursma$gmin)
SpParams <- populateTraits(SpParams, duursma, 
                           trait_mapping = list("Gswmin" = "gmin"),
                           taxon_column = "species",
                           scalar_functions = list("Gswmin" = function(x) {x/1000})) #From mmolÂ·s-1Â·m-2 to molÂ·s-1Â·m-2

```

```{r}
SpParams <- populateTraits(SpParams, hoshika, 
                           trait_mapping = list("Gswmax" = "gmax.(mol.m-2.s-1)") ,
                           taxon_column = "Species")
```

#### Stem maximum hydraulic conductivity
($K_{stem, max, ref}$) 

```{r}
SpParams <- populateTraits(SpParams, hydratry, 
                           trait_mapping = c("Kmax_stemxylem" = "Ks"),
                           taxon_column = "Species")
```

#### Stem hydraulic vulnerability

```{r}
martin_stpaul$VCstem_c <- NA
martin_stpaul$VCstem_d <- NA
for(i in 1:nrow(martin_stpaul)) {
  if((!is.na(martin_stpaul$P50[i])) && (!is.na(martin_stpaul$P12[i]))) {
    weib = hydraulics_psi2Weibull(psi50 = martin_stpaul$P50[i],
                                  psi12 = martin_stpaul$P12[i])
    martin_stpaul$VCstem_c[i] = weib[["c"]]
    martin_stpaul$VCstem_d[i] = weib[["d"]]
  }
}
choat$P50 = as.numeric(choat$P50)
choat$P88 = as.numeric(choat$P88)
choat$VCstem_c <- NA
choat$VCstem_d <- NA
for(i in 1:nrow(choat)) {
  if((!is.na(choat$P50[i])) && (!is.na(choat$P88[i]))) {
    weib = hydraulics_psi2Weibull(psi50 = choat$P50[i],
                                  psi88 = choat$P88[i])
    choat$VCstem_c[i] = weib[["c"]]
    choat$VCstem_d[i] = weib[["d"]]
  }
}
```

```{r}
VC_data = rbind(martin_stpaul[, c("Species", "VCstem_c", "VCstem_d")],
                choat[, c("Species", "VCstem_c", "VCstem_d")])
SpParams <- populateTraits(SpParams, VC_data, 
                           trait_mapping = list("VCstem_c" = "VCstem_c",
                                                "VCstem_d" = "VCstem_d"),
                           taxon_column = "Species")
```

#### Photosynthetic capacity

```{r}
TRY_Narea <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_50.rds"))
TRY_Narea <- TRY_Narea[, c("AccSpeciesName", "StdValue")]
names(TRY_Narea) <- c("Species", "Narea")
```
```{r}
Narea_data <-rbind(hydratry[,c("Species", "Narea")],
                   TRY_Narea)
SpParams <- populateTraits(SpParams, Narea_data, 
                                trait_mapping = c("Narea" = "Narea"),
                                taxon_column = "Species")
```

```{r}
TRY_Vmax298  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_186.rds"))
SpParams <- populateTraits(SpParams, TRY_Vmax298, 
                           trait_mapping = c("Vmax298" = "StdValue"),
                           taxon_column = "AccSpeciesName")
```

```{r}
TRY_Jmax298  <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_269.rds"))
SpParams <- populateTraits(SpParams, TRY_Jmax298, 
                           trait_mapping = c("Jmax298" = "StdValue"),
                           taxon_column = "AccSpeciesName")
```

### Carbon balance and growth
#### Wood carbon content

```{r}
TRY_WoodC <-readRDS(file.path(DB_path,"TraitDatabases/TRY/TRY_traits/TRY_407.rds"))
SpParams <- populateTraits(SpParams, TRY_WoodC, 
                           trait_mapping = c("WoodC" = "StdValue"),
                           scalar_functions = c("WoodC" = function(x){x/1000}), #mg/g to g/g 
                           taxon_column = "AccSpeciesName")
```

## Recruitment parameters
